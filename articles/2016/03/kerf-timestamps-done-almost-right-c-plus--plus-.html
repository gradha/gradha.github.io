<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang='en'>
	<head>
		<title>Kerf timestamps done almost right: C++ - Rants from the Ballmer Peak</title>
		<meta name="viewport" content="initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../../../css/normalize.css">
		<link rel="stylesheet" href="../../../css/style.css">
		<link href="../../../feed.xml" title="Articles" type="application/atom+xml" rel="alternate">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	</head>
	<body>
	<div class="content">
		<h3><a href="../../../index.html">Rants from the Ballmer Peak</a> <a
				href="../../../feed.xml"><img
			alt="rss feed" src="../../../i/Feed-icon.svg"
			width="18pt" height="18pt"></a></h3>
    <!--table border="0" bgcolor="#cccccc"><tr><td><i>Need a great Android/KMP developer? <a href="https://www.linkedin.com/in/gradha/">Hire me!</a></i>
    </table><br-->
		<h1>Kerf timestamps done almost right: C++</h1><p>In the <a href="kerf-timestamps-done-almost-right-a-new-type.html">first chapter of the series</a> we reached the conclusion that to implement Kerf's timestamp types we need the following features from a programming language:</p>
<ol><li>Value type semantics with strong typing to avoid mistakes.</li><li>Instancing types on the stack to avoid slow heap memory allocations and alleviate manual memory handling or garbage collector pressure.</li><li>Custom literals for easier construction of such types.</li><li>Operator overloading to implement all possible custom operations.</li><li>Generics are not necessary but help with implementation.</li></ol>
<table border="1" bgcolor="#cccccc"><tr><td style="vertical-align: middle;"
><b>META NAVIGATION START</b>
<p>This is a really long article (<a class="blink"
href="http://www.amazon.com/Effective-Modern-Specific-Ways-Improve/dp/1491903996"
>Buy Effective Modern C++!</a>) which has
been split in different chapters because it is (<a class="blink"
href="http://www.amazon.com/Effective-Modern-Specific-Ways-Improve/dp/1491903996"
>Effective Modern C++ on sale!</a>) unsuitable for today's average attention span
and lets me
maximize (<a href="http://www.amazon.com/Effective-Modern-Specific-Ways-Improve/dp/1491903996" class="blink"
>Get Effective Modern C++ now!</a>) page ads.
<p><b>META NAVIGATION END</b>
</td><td nowrap>
<ol>
<li><a href="kerf-timestamps-done-almost-right-a-new-type.html">a new type?</a>
<li><a href="kerf-timestamps-done-almost-right-nim.html">Nim</a>
<li>C++ <b>You are here!</b>
<li><a href="kerf-timestamps-done-almost-right-swift.html">Swift</a>
<li><a href="kerf-timestamps-done-almost-right-wtf…-java.html">WTF… Java?</a>
<li><a href="kerf-timestamps-done-almost-right-conclusions.html">conclusions</a>
</ol></td></tr></table><a href="http://arcturus127.tistory.com/858"><img
    src="../../../i/kerf_cpp.jpg"
    alt="C++?! That language is older than me! How can you even use something like that?"
    style="width:100%;max-width:600px" align="right"
    hspace="8pt" vspace="8pt"></a><p><a href="https://en.wikipedia.org/wiki/C%2B%2B">C++</a> is a general purpose programming language. It has imperative, object-oriented and generic programming features, while also providing facilities for low-level memory manipulation. Before the initial standardization in 1998, C++ was developed by Bjarne Stroustrup at Bell Labs since 1979, as an extension of the C language. Running our requirement list against C++'s feature set we get:</p>
<ol><li>C++ has value type semantics with strong typing to avoid mistakes (yay!).</li><li>Allows instancing types on the stack, either through strong typedefs or through custom structs (yay!).</li><li><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2007/n2378.pdf">Allows user-defined literals</a> (yay!).</li><li>Allows operator overloading (yay!).</li><li>Supports generics, but they kind of fall short when you try to extend things like the <a href="https://en.wikipedia.org/wiki/Standard_Template_Library">standard template library (STL)</a> (booo). Luckily this is not a requirement.</li></ol><p>There was a time where I was on top of C++ for work but now I don't follow it. The implementation I'll show off (<a href="https://github.com/gradha/kerf_timestamps_done_almost_right/tree/master/cpp">available at GitHub</a>) is <a href="kerf-timestamps-done-almost-right-nim.html">based on the Nim implementation</a> and likely inferior to what you would get from a hardcore C++ developer. In fact I had to learn a few things to make my mess compile. The main problem is that C++ has evolved into a complex syntax which is ambiguous, <a href="http://stackoverflow.com/a/1004737/172690">requires serious compiler implementations</a> and looks like <a href="https://www.perl.org">Perl</a>, so you really have to be practicing it to know all the rough corners (so you can avoid them).  But you will shortly see for yourself that these are no barriers to emulate Kerf's timestamp types.</p>
<h2>Structs as distinct types</h2><p>C++ doesn't have <a href="http://stackoverflow.com/a/1004737/172690">Nim's distinct types</a> but we can emulate them through <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_nanos.h#L7-L30">a structure which contains a single long value</a>:</p>
<p><pre class='code'><span class="Keyword">struct</span> <span class="Identifier">Nano</span>
<span class="Punctuation">{</span>
        <span class="Keyword">long</span> <span class="Keyword">long</span> <span class="Identifier">val</span><span class="Punctuation">;</span> <span class="Comment">// The timestamp</span>
        <span class="Comment">// construct a Value from a long long</span>
        <span class="Identifier">constexpr</span> <span class="Identifier">explicit</span> <span class="Identifier">Nano</span><span class="Punctuation">(</span><span class="Keyword">unsigned</span> <span class="Keyword">long</span> <span class="Keyword">long</span> <span class="Keyword">int</span> <span class="Identifier">x</span><span class="Punctuation">)</span> <span class="Punctuation">:</span> <span class="Identifier">val</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">)</span> <span class="Punctuation">{</span><span class="Punctuation">}</span>
        
        <span class="Keyword">inline</span> <span class="Identifier">Nano</span> <span class="Identifier">operator</span><span class="Operator">+</span><span class="Punctuation">(</span><span class="Keyword">const</span> <span class="Identifier">Nano</span><span class="Operator">&amp;</span> <span class="Identifier">rhs</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Identifier">Nano</span> <span class="Identifier">operator</span><span class="Operator">-</span><span class="Punctuation">(</span><span class="Keyword">const</span> <span class="Identifier">Nano</span><span class="Operator">&amp;</span> <span class="Identifier">rhs</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Identifier">Nano</span> <span class="Identifier">operator</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Keyword">const</span> <span class="Keyword">int</span><span class="Operator">&amp;</span> <span class="Identifier">rhs</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Identifier">Nano</span> <span class="Identifier">operator</span><span class="Identifier">/</span><span class="Punctuation">(</span><span class="Keyword">const</span> <span class="Keyword">int</span><span class="Operator">&amp;</span> <span class="Identifier">rhs</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Keyword">int</span> <span class="Identifier">year</span><span class="Punctuation">(</span><span class="Keyword">void</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Keyword">int</span> <span class="Identifier">month</span><span class="Punctuation">(</span><span class="Keyword">void</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Keyword">int</span> <span class="Identifier">week</span><span class="Punctuation">(</span><span class="Keyword">void</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Keyword">int</span> <span class="Identifier">day</span><span class="Punctuation">(</span><span class="Keyword">void</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Keyword">int</span> <span class="Identifier">hour</span><span class="Punctuation">(</span><span class="Keyword">void</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Keyword">int</span> <span class="Identifier">minute</span><span class="Punctuation">(</span><span class="Keyword">void</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Keyword">int</span> <span class="Identifier">second</span><span class="Punctuation">(</span><span class="Keyword">void</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Keyword">int</span> <span class="Identifier">millisecond</span><span class="Punctuation">(</span><span class="Keyword">void</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Keyword">int</span> <span class="Identifier">microsecond</span><span class="Punctuation">(</span><span class="Keyword">void</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        <span class="Keyword">inline</span> <span class="Keyword">int</span> <span class="Identifier">nanosecond</span><span class="Punctuation">(</span><span class="Keyword">void</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
        
        <span class="Identifier">template</span><span class="Operator">&lt;</span><span class="Identifier">typename</span> <span class="Identifier">T</span><span class="Operator">&gt;</span>
        <span class="Identifier">std</span><span class="Punctuation">:</span><span class="Punctuation">:</span><span class="Identifier">vector</span><span class="Operator">&lt;</span><span class="Identifier">Nano</span><span class="Operator">&gt;</span> <span class="Identifier">operator</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Keyword">const</span> <span class="Identifier">std</span><span class="Punctuation">:</span><span class="Punctuation">:</span><span class="Identifier">vector</span><span class="Operator">&lt;</span><span class="Identifier">T</span><span class="Operator">&gt;&amp;</span> <span class="Identifier">rhs</span><span class="Punctuation">)</span> <span class="Keyword">const</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span><span class="Punctuation">;</span>
</pre></p>
<p>Right there you see the <code>val</code> instance variable and a bunch of forward declarations for operators and calendar component getters. There are <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_nanos.h#L32-L59">even more constants and forward declarations outside of the structure</a>, but I tried to make it <span style="font-style: italic;">clean</span> putting the implementation of those methods inside the <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_nanos_inline.h">time_nanos_inline.h header file</a> which is <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_nanos.h#L61">automatically included by time_nanos.h</a>. The user defined literals have to be a <code>constexpr</code>, so they have to be <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_nanos_inline.h#L40-L75">included in all the compilations</a> for the compiler to be able to inline them. This is essentially the same as the Nim compiler did, with the difference that in Nim you don't split the header from the implementation. C++ doesn't have nice built in <code>echo()</code> like functions, so we need to <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_nanos_inline.h#L108-L118">roll our own vector contents dumping code</a>. Something similar happens with <code>map()</code> like functions, the STL <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_nanos_inline.h#L120-L127">needs help in the right direction</a>.</p>
<p>To output a <code>Nano</code> in C++ object oriented fashion we <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_nanos.cpp#L19-L65">overload the &lt;&lt; operator</a>:</p>
<p><pre class='code'><span class="Identifier">ostream</span><span class="Operator">&amp;</span> <span class="Identifier">operator</span><span class="Operator">&lt;&lt;</span><span class="Punctuation">(</span><span class="Identifier">ostream</span><span class="Operator">&amp;</span> <span class="Identifier">o</span><span class="Punctuation">,</span> <span class="Keyword">const</span> <span class="Identifier">Nano</span><span class="Operator">&amp;</span> <span class="Identifier">x</span><span class="Punctuation">)</span>
<span class="Punctuation">{</span>
        <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">&gt;=</span> <span class="DecNumber">0</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">&lt;</span> <span class="DecNumber">1</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
                <span class="Identifier">o</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;0s&quot;</span><span class="Punctuation">;</span>
                <span class="Keyword">return</span> <span class="Identifier">o</span><span class="Punctuation">;</span>
        <span class="Punctuation">}</span>
        
        <span class="Keyword">long</span> <span class="Keyword">long</span> <span class="Identifier">nano</span> <span class="Operator">=</span> <span class="Identifier">x</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">%</span> <span class="DecNumber">1000000000</span><span class="Punctuation">;</span>
        <span class="Keyword">long</span> <span class="Keyword">long</span> <span class="Identifier">seconds</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">.</span><span class="Identifier">val</span> / <span class="DecNumber">1000000000</span><span class="Punctuation">)</span> <span class="Operator">%</span> <span class="DecNumber">60</span><span class="Punctuation">;</span>
        <span class="Keyword">long</span> <span class="Keyword">long</span> <span class="Identifier">minutes</span> <span class="Operator">=</span> <span class="Identifier">x</span><span class="Punctuation">.</span><span class="Identifier">val</span> / <span class="DecNumber">60000000000</span><span class="Punctuation">;</span>
        <span class="Keyword">long</span> <span class="Keyword">long</span> <span class="Identifier">hours</span><span class="Punctuation">,</span> <span class="Identifier">days</span><span class="Punctuation">,</span> <span class="Identifier">years</span><span class="Punctuation">;</span>
        
        <span class="Identifier">string</span> <span class="Identifier">buf</span> <span class="Operator">=</span> <span class="Identifier">string</span><span class="Punctuation">(</span><span class="StringLit">&quot;&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">nano</span><span class="Punctuation">)</span> <span class="Punctuation">{</span> <span class="Identifier">buf</span> <span class="Operator">+=</span> <span class="Identifier">to_string</span><span class="Punctuation">(</span><span class="Identifier">nano</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">buf</span> <span class="Operator">+=</span> <span class="StringLit">&quot;ns&quot;</span><span class="Punctuation">;</span> <span class="Punctuation">}</span>
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">seconds</span><span class="Punctuation">)</span> <span class="Punctuation">{</span> <span class="Identifier">buf</span><span class="Punctuation">.</span><span class="Identifier">insert</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="Identifier">to_string</span><span class="Punctuation">(</span><span class="Identifier">seconds</span><span class="Punctuation">)</span> <span class="Operator">+</span> <span class="StringLit">&quot;s&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Punctuation">}</span>
        
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">minutes</span> <span class="Operator">&lt;</span> <span class="DecNumber">1</span><span class="Punctuation">)</span>
                <span class="Keyword">goto</span> <span class="Identifier">end</span><span class="Punctuation">;</span>
        
        <span class="Identifier">hours</span> <span class="Operator">=</span> <span class="Identifier">minutes</span> / <span class="DecNumber">60</span><span class="Punctuation">;</span>
        <span class="Identifier">minutes</span> <span class="Operator">=</span> <span class="Identifier">minutes</span> <span class="Operator">%</span> <span class="DecNumber">60</span><span class="Punctuation">;</span>
        
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">minutes</span><span class="Punctuation">)</span> <span class="Punctuation">{</span> <span class="Identifier">buf</span><span class="Punctuation">.</span><span class="Identifier">insert</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="Identifier">to_string</span><span class="Punctuation">(</span><span class="Identifier">minutes</span><span class="Punctuation">)</span> <span class="Operator">+</span> <span class="StringLit">&quot;m&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Punctuation">}</span>
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">hours</span> <span class="Operator">&lt;</span> <span class="DecNumber">1</span><span class="Punctuation">)</span>
                <span class="Keyword">goto</span> <span class="Identifier">end</span><span class="Punctuation">;</span>
        
        <span class="Identifier">days</span> <span class="Operator">=</span> <span class="Identifier">hours</span> / <span class="DecNumber">24</span><span class="Punctuation">;</span>
        <span class="Identifier">hours</span> <span class="Operator">=</span> <span class="Identifier">hours</span> <span class="Operator">%</span> <span class="DecNumber">24</span><span class="Punctuation">;</span>
        
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">hours</span><span class="Punctuation">)</span> <span class="Punctuation">{</span> <span class="Identifier">buf</span><span class="Punctuation">.</span><span class="Identifier">insert</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="Identifier">to_string</span><span class="Punctuation">(</span><span class="Identifier">hours</span><span class="Punctuation">)</span> <span class="Operator">+</span> <span class="StringLit">&quot;h&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Punctuation">}</span>
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">days</span> <span class="Operator">&lt;</span> <span class="DecNumber">1</span><span class="Punctuation">)</span>
                <span class="Keyword">goto</span> <span class="Identifier">end</span><span class="Punctuation">;</span>
        
        <span class="Identifier">years</span> <span class="Operator">=</span> <span class="Identifier">days</span> / <span class="DecNumber">365</span><span class="Punctuation">;</span>
        <span class="Identifier">days</span> <span class="Operator">=</span> <span class="Identifier">days</span> <span class="Operator">%</span> <span class="DecNumber">365</span><span class="Punctuation">;</span>
        
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">days</span><span class="Punctuation">)</span> <span class="Punctuation">{</span> <span class="Identifier">buf</span><span class="Punctuation">.</span><span class="Identifier">insert</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="Identifier">to_string</span><span class="Punctuation">(</span><span class="Identifier">days</span><span class="Punctuation">)</span> <span class="Operator">+</span> <span class="StringLit">&quot;d&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Punctuation">}</span>
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">years</span> <span class="Operator">&lt;</span> <span class="DecNumber">1</span><span class="Punctuation">)</span>
                <span class="Keyword">goto</span> <span class="Identifier">end</span><span class="Punctuation">;</span>
        
        <span class="Identifier">buf</span><span class="Punctuation">.</span><span class="Identifier">insert</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="Identifier">to_string</span><span class="Punctuation">(</span><span class="Identifier">years</span><span class="Punctuation">)</span> <span class="Operator">+</span> <span class="StringLit">&quot;y&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>

<span class="Identifier">end</span><span class="Punctuation">:</span>
        <span class="Identifier">o</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">buf</span><span class="Punctuation">;</span>
        <span class="Keyword">return</span> <span class="Identifier">o</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span>
</pre></p>
<p>As you can see this is a straight copy from the Nim version, which goes decomposing the value internally and generating the necessary parts of the string if they are not zero. Not clean, but does the job. The <code>Nano</code> <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_nanos.cpp#L69-L93">unit testing code</a> is pretty similar to the previous Nim implementation and even Kerf:</p>
<p><pre class='code'><span class="Keyword">void</span> <span class="Identifier">test_nanos</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Punctuation">{</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;Testing nanos module&quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">Nano</span><span class="Punctuation">(</span><span class="DecNumber">500</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot; = &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="DecNumber">500</span><span class="Identifier">_ns</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">u_second</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot; = &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="DecNumber">1</span><span class="Identifier">_s</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">u_minute</span> <span class="Operator">+</span> <span class="Identifier">u_second</span> <span class="Operator">+</span> <span class="Identifier">Nano</span><span class="Punctuation">(</span><span class="DecNumber">500</span><span class="Punctuation">)</span>
                <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot; = &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="DecNumber">1</span><span class="Identifier">_i</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_s</span> <span class="Operator">+</span> <span class="DecNumber">500</span><span class="Identifier">_ns</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">u_hour</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot; = &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="DecNumber">1</span><span class="Identifier">_h</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="DecNumber">1</span><span class="Identifier">_h</span> <span class="Operator">+</span> <span class="DecNumber">23</span><span class="Identifier">_i</span> <span class="Operator">+</span> <span class="DecNumber">45</span><span class="Identifier">_s</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot; = &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">composed_difference</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">u_day</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot; = &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="DecNumber">1</span><span class="Identifier">_d</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">u_year</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot; = &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="DecNumber">1</span><span class="Identifier">_y</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">u_year</span> <span class="Operator">-</span> <span class="DecNumber">1</span><span class="Identifier">_d</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        
        <span class="Keyword">const</span> <span class="Keyword">auto</span> <span class="Identifier">a</span> <span class="Operator">=</span> <span class="Identifier">composed_difference</span> <span class="Operator">+</span> <span class="DecNumber">3</span><span class="Identifier">_y</span> <span class="Operator">+</span> <span class="DecNumber">6</span><span class="Identifier">_m</span> <span class="Operator">+</span> <span class="DecNumber">4</span><span class="Identifier">_d</span> <span class="Operator">+</span> <span class="DecNumber">12987</span><span class="Identifier">_ns</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;total &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">year &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">year</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">month &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">month</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">day &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">day</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">hour &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">hour</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">minute &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">minute</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">second &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">second</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">microsecond &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">microsecond</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">millisecond &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">millisecond</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
        <span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">nanosecond &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">nanosecond</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span>
</pre></p>
<a href="http://dijkcrayon.tistory.com/448"><img
    src="../../../i/kerf_ugly.jpg"
    alt="Slightly ugly? I don't want to see what's next"
    style="width:100%;max-width:600px" align="right"
    hspace="8pt" vspace="8pt"></a><p>The main differences here are that we are using <code>cout</code> standard output object with the <code>&lt;&lt;</code> operator which has terribly verbose line terminators (<code>endl</code>). However the real code is actually quite similar to the Nim version, we just have to replace the dot used to separate the literal from the postfix proc invocation into an underscore (<code>1_h + 23_i + 45_s</code>). Of course C++ doesn't let you omit the parentheses in method calls, so the date component getters like <code>year()</code> or <code>week()</code> are slightly ugly.</p>
<h2>The Stamp type</h2><p>The <code>Stamp</code> implementation is <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_stamp.h#L9-L34">not going to surprise anybody, being a copy of the Nano type with a few changes here and there</a>. Here's an excerpt:</p>
<p><pre class='code'><span class="Keyword">struct</span> <span class="Identifier">Stamp</span> <span class="Punctuation">{</span>
        <span class="Keyword">long</span> <span class="Keyword">long</span> <span class="Identifier">val</span><span class="Punctuation">;</span>
        
        <span class="Comment">// …lots of boring stuff goes here…</span>
<span class="Punctuation">}</span><span class="Punctuation">;</span>

<span class="Identifier">std</span><span class="Punctuation">:</span><span class="Punctuation">:</span><span class="Identifier">ostream</span><span class="Operator">&amp;</span> <span class="Identifier">operator</span><span class="Operator">&lt;&lt;</span><span class="Punctuation">(</span><span class="Identifier">std</span><span class="Punctuation">:</span><span class="Punctuation">:</span><span class="Identifier">ostream</span><span class="Operator">&amp;</span> <span class="Identifier">o</span><span class="Punctuation">,</span> <span class="Keyword">const</span> <span class="Identifier">Stamp</span><span class="Operator">&amp;</span> <span class="Identifier">x</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Identifier">constexpr</span> <span class="Identifier">Stamp</span> <span class="Identifier">operator</span><span class="StringLit">&quot;&quot;</span> <span class="Identifier">_date</span><span class="Punctuation">(</span><span class="Keyword">const</span> <span class="Keyword">char</span><span class="Operator">*</span> <span class="Identifier">x</span><span class="Punctuation">,</span> <span class="Keyword">const</span> <span class="Identifier">size_t</span> <span class="Identifier">len</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
</pre></p>
<p>There is not much to explain here given what has already been said about Nim in the previous chapter and about C++ in this one.  While the stream <code>&lt;&lt;</code> operator can be <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_stamp.cpp#L21-L62">implemented in a .cpp file</a> and hidden behind a header file, the string input accepting <code>_date</code> user defined literal <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_stamp_inline.h#L17-L95">has to appear in the header file</a>:</p>
<p><pre class='code'><span class="Comment">// Requires C++14 support.</span>
<span class="Identifier">constexpr</span> <span class="Identifier">Stamp</span> <span class="Identifier">operator</span><span class="StringLit">&quot;&quot;</span> <span class="Identifier">_date</span><span class="Punctuation">(</span><span class="Keyword">const</span> <span class="Keyword">char</span><span class="Operator">*</span> <span class="Identifier">x</span><span class="Punctuation">,</span> <span class="Keyword">const</span> <span class="Identifier">size_t</span> <span class="Identifier">len</span><span class="Punctuation">)</span>
<span class="Punctuation">{</span>
        <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="Identifier">len</span> <span class="Operator">&gt;=</span> <span class="DecNumber">10</span> <span class="Identifier">and</span> <span class="Identifier">len</span> <span class="Operator">&lt;</span> <span class="Identifier">MAX_STAMP_LEN</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        
        <span class="Keyword">int</span> <span class="Identifier">temp</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">1000</span><span class="Punctuation">;</span>
        <span class="Identifier">temp</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">100</span><span class="Punctuation">;</span>
        <span class="Identifier">temp</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">10</span><span class="Punctuation">;</span>
        <span class="Identifier">temp</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">1</span><span class="Punctuation">;</span>
        <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="Identifier">temp</span> <span class="Operator">&gt;=</span> <span class="Identifier">EPOCH_OFFSET</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        <span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">;</span>
        
        <span class="Identifier">Stamp</span> <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Identifier">Stamp</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Identifier">temp</span> <span class="Operator">-</span> <span class="Identifier">EPOCH_OFFSET</span><span class="Punctuation">)</span>
                <span class="Operator">*</span> <span class="Identifier">ONE_SECOND</span> <span class="Operator">*</span> <span class="DecNumber">60</span> <span class="Operator">*</span> <span class="DecNumber">60</span> <span class="Operator">*</span> <span class="DecNumber">24</span> <span class="Operator">*</span> <span class="DecNumber">365</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        
        <span class="Identifier">temp</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">10</span><span class="Punctuation">;</span>
        <span class="Identifier">temp</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">;</span>
        <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="Identifier">temp</span> <span class="Operator">&gt;</span> <span class="DecNumber">0</span> <span class="Operator">&amp;&amp;</span> <span class="Identifier">temp</span> <span class="Operator">&lt;</span> <span class="DecNumber">13</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        <span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">;</span>
        
        <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Identifier">temp</span> <span class="Operator">-</span> <span class="DecNumber">1</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="Identifier">ONE_SECOND</span> <span class="Operator">*</span> <span class="DecNumber">60</span> <span class="Operator">*</span> <span class="DecNumber">60</span> <span class="Operator">*</span> <span class="DecNumber">24</span> <span class="Operator">*</span> <span class="DecNumber">30</span><span class="Punctuation">;</span>
        
        <span class="Identifier">temp</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">10</span><span class="Punctuation">;</span>
        <span class="Identifier">temp</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">;</span>
        <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="Identifier">temp</span> <span class="Operator">&gt;</span> <span class="DecNumber">0</span> <span class="Operator">&amp;&amp;</span> <span class="Identifier">temp</span> <span class="Operator">&lt;</span> <span class="DecNumber">32</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        
        <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Identifier">temp</span> <span class="Operator">-</span> <span class="DecNumber">1</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="Identifier">ONE_SECOND</span> <span class="Operator">*</span> <span class="DecNumber">60</span> <span class="Operator">*</span> <span class="DecNumber">60</span> <span class="Operator">*</span> <span class="DecNumber">24</span><span class="Punctuation">;</span>
        
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">len</span> <span class="Operator">&lt;</span> <span class="Identifier">MINUTES_START</span> <span class="Operator">-</span> <span class="DecNumber">1</span><span class="Punctuation">)</span>
                <span class="Keyword">return</span> <span class="Identifier">result</span><span class="Punctuation">;</span>
        
        <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="CharLit">'T'</span> <span class="Operator">==</span> <span class="Operator">*</span><span class="Identifier">x</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        <span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">;</span>
        
        <span class="Identifier">temp</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">10</span><span class="Punctuation">;</span>
        <span class="Identifier">temp</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">;</span>
        <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="Identifier">temp</span> <span class="Operator">&gt;=</span> <span class="DecNumber">0</span> <span class="Operator">&amp;&amp;</span> <span class="Identifier">temp</span> <span class="Operator">&lt;</span> <span class="DecNumber">24</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Identifier">temp</span> <span class="Operator">*</span> <span class="Identifier">ONE_SECOND</span> <span class="Operator">*</span> <span class="DecNumber">60</span> <span class="Operator">*</span> <span class="DecNumber">60</span><span class="Punctuation">;</span>
        
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">len</span> <span class="Operator">&lt;</span> <span class="Identifier">SECONDS_START</span> <span class="Operator">-</span> <span class="DecNumber">1</span><span class="Punctuation">)</span>
                <span class="Keyword">return</span> <span class="Identifier">result</span><span class="Punctuation">;</span>
        
        <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="CharLit">':'</span> <span class="Operator">==</span> <span class="Operator">*</span><span class="Identifier">x</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        <span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">;</span>
        
        <span class="Identifier">temp</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">10</span><span class="Punctuation">;</span>
        <span class="Identifier">temp</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">;</span>
        <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="Identifier">temp</span> <span class="Operator">&gt;=</span> <span class="DecNumber">0</span> <span class="Operator">&amp;&amp;</span> <span class="Identifier">temp</span> <span class="Operator">&lt;</span> <span class="DecNumber">60</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Identifier">temp</span> <span class="Operator">*</span> <span class="Identifier">ONE_SECOND</span> <span class="Operator">*</span> <span class="DecNumber">60</span><span class="Punctuation">;</span>
        
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">len</span> <span class="Operator">&lt;</span> <span class="Identifier">NANOS_START</span> <span class="Operator">-</span> <span class="DecNumber">1</span><span class="Punctuation">)</span>
                <span class="Keyword">return</span> <span class="Identifier">result</span><span class="Punctuation">;</span>
        
        <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="CharLit">':'</span> <span class="Operator">==</span> <span class="Operator">*</span><span class="Identifier">x</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        <span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">;</span>
        
        <span class="Identifier">temp</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">10</span><span class="Punctuation">;</span>
        <span class="Identifier">temp</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">;</span>
        <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="Identifier">temp</span> <span class="Operator">&gt;=</span> <span class="DecNumber">0</span> <span class="Operator">&amp;&amp;</span> <span class="Identifier">temp</span> <span class="Operator">&lt;</span> <span class="DecNumber">60</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Identifier">temp</span> <span class="Operator">*</span> <span class="Identifier">ONE_SECOND</span><span class="Punctuation">;</span>
        
        <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">len</span> <span class="Operator">&gt;</span> <span class="Identifier">NANOS_START</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
                <span class="Identifier">assert</span><span class="Punctuation">(</span><span class="CharLit">'.'</span> <span class="Operator">==</span> <span class="Operator">*</span><span class="Identifier">x</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
                <span class="Identifier">x</span><span class="Operator">++</span><span class="Punctuation">;</span>
<span class="Preprocessor">#define</span> <span class="Identifier">_CHECK</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Keyword">do</span> <span class="Punctuation">{</span> <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span> <span class="Operator">&lt;</span> <span class="CharLit">'0'</span> <span class="Operator">||</span> <span class="Operator">*</span><span class="Identifier">x</span> <span class="Operator">&gt;</span> <span class="CharLit">'9'</span><span class="Punctuation">)</span> <span class="Keyword">return</span> <span class="Identifier">result</span><span class="Punctuation">;</span> <span class="Punctuation">}</span> <span class="Keyword">while</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">)</span>
                <span class="Identifier">_CHECK</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">100000000</span><span class="Punctuation">;</span>
                <span class="Identifier">_CHECK</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">10000000</span><span class="Punctuation">;</span>
                <span class="Identifier">_CHECK</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">1000000</span><span class="Punctuation">;</span>
                <span class="Identifier">_CHECK</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">100000</span><span class="Punctuation">;</span>
                <span class="Identifier">_CHECK</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">10000</span><span class="Punctuation">;</span>
                <span class="Identifier">_CHECK</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">1000</span><span class="Punctuation">;</span>
                <span class="Identifier">_CHECK</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">100</span><span class="Punctuation">;</span>
                <span class="Identifier">_CHECK</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">10</span><span class="Punctuation">;</span>
                <span class="Identifier">_CHECK</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">result</span><span class="Punctuation">.</span><span class="Identifier">val</span> <span class="Operator">+=</span> <span class="Punctuation">(</span><span class="Keyword">long</span> <span class="Keyword">long</span><span class="Punctuation">)</span><span class="Punctuation">(</span><span class="Operator">*</span><span class="Identifier">x</span><span class="Operator">++</span> <span class="Operator">-</span> <span class="CharLit">'0'</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="DecNumber">1</span><span class="Punctuation">;</span>
<span class="Preprocessor">#undef</span> <span class="Identifier">_VALID</span>
        <span class="Punctuation">}</span>
        
        <span class="Keyword">return</span> <span class="Identifier">result</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span>
</pre></p>
<p>This implementation looks even uglier thanks to the <code>_CHECK()</code> define, which being a nasty pre processor construct uses one of the typical <code>do {…} while(0)</code> constructs to avoid surprises. Despite the perceived ugliness the <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/time_stamp.cpp#L66-L95">final test code still holds its own valiantly</a>:</p>
<p><pre class='code'><span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;Testing stamp module&quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>

<span class="Keyword">auto</span> <span class="Identifier">a</span> <span class="Operator">=</span> <span class="StringLit">&quot;2012-01-01&quot;</span><span class="Identifier">_date</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;let's start at &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;plus one day is &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_d</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;plus one month is &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_m</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;plus one month and a day is &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_m</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_d</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;…plus 1h15i17s &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_m</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_d</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_h</span> <span class="Operator">+</span> <span class="DecNumber">15</span><span class="Identifier">_i</span> <span class="Operator">+</span> <span class="DecNumber">17</span><span class="Identifier">_s</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;…plus 23 hours &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_m</span> <span class="Operator">+</span> <span class="DecNumber">2</span><span class="Identifier">_d</span> <span class="Operator">-</span> <span class="DecNumber">1</span><span class="Identifier">_h</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;2001.01.01T01&quot;</span><span class="Identifier">_date</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;2001.01.01T02:01&quot;</span><span class="Identifier">_date</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;2001.01.01T03:02:01&quot;</span><span class="Identifier">_date</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;2001.01.01T04:09:02.1&quot;</span><span class="Identifier">_date</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;2001.01.01T04:09:02.12&quot;</span><span class="Identifier">_date</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;2001.01.01T04:09:02.123&quot;</span><span class="Identifier">_date</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;2001.01.01T05:04:03.0123&quot;</span><span class="Identifier">_date</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;2001.01.01T06:05:04.012345678&quot;</span><span class="Identifier">_date</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">a</span> <span class="Operator">=</span> <span class="StringLit">&quot;2001.01.01T06:05:04.012345678&quot;</span><span class="Identifier">_date</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">year &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">year</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">month &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">month</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">day &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">day</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">hour &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">hour</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">minute &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">minute</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">second &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">second</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">microsecond &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">microsecond</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">millisecond &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">millisecond</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit">nanosecond &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">nanosecond</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
</pre></p>
<p>The output is as expected from the Nim and Kerf implementations so it will be omitted. The input is pretty much the same as Nim, though a little less flexible and cluttered. But hey, if you are writing C++ for a living you already <a href="../../2015/04/whitespace-goto-fail.html">filter out all those signs anyway</a>. Good for you!</p>
<h2>The uglier finale</h2><p>For the comparison with the Kef blog examples we wanted to mimic, you can look at the full source code in the <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/units.cpp#L9">units.cpp file at GitHub</a>. Just like the previous section the code is similar to Nim, only a little bit uglier, so I won't copy everything. The new and interesting bits are in <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/units.cpp#L21-L26">the use of STL containers</a>:</p>
<p><pre class='code'><span class="Keyword">auto</span> <span class="Identifier">r</span> <span class="Operator">=</span> <span class="Identifier">range</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="DecNumber">10</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Keyword">auto</span> <span class="Identifier">offsets</span> <span class="Operator">=</span> <span class="Identifier">map</span><span class="Punctuation">(</span><span class="Identifier">r</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="Punctuation">]</span> <span class="Punctuation">(</span><span class="Keyword">int</span> <span class="Identifier">i</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Keyword">return</span> <span class="Punctuation">(</span><span class="DecNumber">1</span><span class="Identifier">_m</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_d</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_h</span> <span class="Operator">+</span> <span class="DecNumber">15</span><span class="Identifier">_i</span> <span class="Operator">+</span> <span class="DecNumber">17</span><span class="Identifier">_s</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="Identifier">i</span><span class="Punctuation">;</span>
        <span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Keyword">auto</span> <span class="Identifier">values</span> <span class="Operator">=</span> <span class="Identifier">map</span><span class="Punctuation">(</span><span class="Identifier">offsets</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="Punctuation">]</span> <span class="Punctuation">(</span><span class="Identifier">Nano</span> <span class="Identifier">x</span><span class="Punctuation">)</span> <span class="Punctuation">{</span> <span class="Keyword">return</span> <span class="StringLit">&quot;2012.01.01&quot;</span><span class="Identifier">_date</span> <span class="Operator">+</span> <span class="Identifier">x</span><span class="Punctuation">;</span> <span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;Example 4: &quot;</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">values</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
</pre></p>
<p>In the beginning C++ didn't have type inference, but through the years it has been implemented in the form of the <code>auto</code> keyword, which avoids us having to explicitly type whatever <code>range()</code> or <code>map()</code> return. And we have to be glad for that, because the things STL containers return tend to look like <a href="https://www.youtube.com/watch?v=3kQuMVffbWA">mythical Cthulhu creatures</a>, not necessarily ugly but with the potential of driving you crazy. Just like in the Nim implementation we initially take little first steps to define the parts of the expression, then we <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/units.cpp#L28-L30">override the necessary operators to make it short and sweet</a>.</p>
<p><pre class='code'><span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;…using helper procs… &quot;</span>
        <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;2012.01.01&quot;</span><span class="Identifier">_date</span> <span class="Operator">+</span> <span class="Punctuation">(</span><span class="DecNumber">1</span><span class="Identifier">_m</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_d</span> <span class="Operator">+</span> <span class="DecNumber">1</span><span class="Identifier">_h</span> <span class="Operator">+</span> <span class="DecNumber">15</span><span class="Identifier">_i</span> <span class="Operator">+</span> <span class="DecNumber">17</span><span class="Identifier">_s</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="Identifier">range</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="DecNumber">10</span><span class="Punctuation">)</span>
        <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Comment">// Kerf: 2012.01.01 + (1m1d + 1h15i17s) times mapright  range(10)</span>
</pre></p>
<p>Hah, C++ sweet and short. That's a first, at least for me, but indeed the line looks comparable to the Kerf version, which was added below as a comment. Unfortunately I had to give up with the sweet and short version of the last example, which was <a href="https://github.com/gradha/kerf_timestamps_done_almost_right/blob/master/cpp/units.cpp#L32-L35">implementing the subscript operator to extract the components of a sequence</a>:</p>
<p><pre class='code'><span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;Example 5 b[week]: &quot;</span> <span class="Operator">&lt;&lt;</span>
        <span class="Identifier">map</span><span class="Punctuation">(</span><span class="Identifier">values</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="Punctuation">]</span> <span class="Punctuation">(</span><span class="Identifier">Stamp</span> <span class="Identifier">x</span><span class="Punctuation">)</span> <span class="Punctuation">{</span> <span class="Keyword">return</span> <span class="Identifier">x</span><span class="Punctuation">.</span><span class="Identifier">week</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Punctuation">}</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
<span class="Identifier">cout</span> <span class="Operator">&lt;&lt;</span> <span class="StringLit">&quot;Example 5 b[second]: &quot;</span> <span class="Operator">&lt;&lt;</span>
        <span class="Identifier">map</span><span class="Punctuation">(</span><span class="Identifier">values</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="Punctuation">]</span> <span class="Punctuation">(</span><span class="Identifier">Stamp</span> <span class="Identifier">x</span><span class="Punctuation">)</span> <span class="Punctuation">{</span> <span class="Keyword">return</span> <span class="Identifier">x</span><span class="Punctuation">.</span><span class="Identifier">second</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Punctuation">}</span><span class="Punctuation">)</span> <span class="Operator">&lt;&lt;</span> <span class="Identifier">endl</span><span class="Punctuation">;</span>
</pre></p>
<p>Yes, that's the whole <code>map()</code> call, no subscript operator overload. Why? Making our custom type as a struct works pretty nicely. However it seems that <a href="http://stackoverflow.com/questions/14420209/overloading-operators-for-vectordouble-class">inheriting from vectors to overload operators is not recommended</a>, and most people suggest using <a href="http://stackoverflow.com/questions/16660437/vector-and-operator-overloading">composition</a> which would make the code even uglier and cumbersome. Doable, but I just don't have the patience to do it. Except for this last <span style="font-style: italic;">trouble</span> from an inexperienced C++ programmer, the C++ language allows us to efficiently implement Kerf's timestamp and the surrounding operators for the same final expressiveness. The only problem is the time you need to invest to learn about all the historical quirks the language has accrued over time and write piles of code to do things which are one liners in more modern languages.</p>
<p>All in all, not bad for a language born in 1983, from the shadow of the <a href="https://en.wikipedia.org/wiki/C_(programming_language)">C programming language</a> which was created in 1972. Let's see what we can do with a newer <a href="kerf-timestamps-done-almost-right-swift.html">hipster language next…</a></p>

<br clear="right"><center>
<a href="http://thestudio.kr/2100"><img
    src="../../../i/kerf_fine.jpg"
    alt="Fine, it works, but look what it did to my hair"
    style="width:100%;max-width:750px" align="center"
    hspace="8pt" vspace="8pt"></a>
</center>
	</div>
		<hr>
		<p>See <a href="../../../index.html">the article index</a> or browse
		articles by tags:     <a href="../../../tags/design.html">design</a>
    ,
    <a href="../../../tags/nim.html">nim</a>
    ,
    <a href="../../../tags/java.html">java</a>
    ,
    <a href="../../../tags/cpp.html">cpp</a>
    ,
    <a href="../../../tags/languages.html">languages</a>
    ,
    <a href="../../../tags/kerf.html">kerf</a>
    ,
    <a href="../../../tags/programming.html">programming</a>
    ,
    <a href="../../../tags/swift.html">swift</a>
    
.<br>Published on: 06/03/2016 22:51. Last update:
			06/03/2016 22:51. <a
			href="../../../feed.xml"><img
			alt="rss feed" src="../../../i/Feed-icon.svg"
			width="18pt" height="18pt"></a><br>
		Copyright 2025 by <a href="../../../about.html">Grzegorz Adam Hankiewicz</a>.<br>
		Generated with <a href="https://github.com/dom96/ipsumgenera">ipsum
			genera</a>. Look at <a
		href="https://github.com/gradha/gradha.github.io">the
		source code</a>.</p>
	</body>
</html>

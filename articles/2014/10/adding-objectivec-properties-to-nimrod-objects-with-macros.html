<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang='en'>
	<head>
		<title>Adding Objective-C properties to Nimrod objects with macros - Rants from the Ballmer Peak</title>
		<meta name="viewport" content="initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../../../css/normalize.css">
		<link rel="stylesheet" href="../../../css/style.css">
		<link href="../../../feed.xml" title="Articles" type="application/atom+xml" rel="alternate">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	</head>
	<body>
	<div class="content">
		<h3><a href="../../../index.html">Rants from the Ballmer Peak</a> <a
				href="../../../feed.xml"><img
			alt="rss feed" src="../../../i/Feed-icon.svg"
			width="18pt" height="18pt"></a></h3>
		<h1>Adding Objective-C properties to Nim objects with macros</h1><p>The <a href="http://nim-lang.org">Nim programming language</a> allows one to use <a href="http://nim-lang.org/docs/manual.html#macros">macros</a> to extend the language.  In a <a href="../06/dirrty-objects-in-dirrty-nimrod.html">previous article</a> we were guided by <a href="https://en.wikipedia.org/wiki/Christina_Aguilera">Christina Aguilera</a> into adding Objective-C like object properties to the Nim programming language. However, the result, while effective, looked quite spartan and low class, like <a href="https://en.wikipedia.org/wiki/File:Dirrty_Slutdrop.jpg">Christina's slutdrop</a>. Here is the code I ended up with:</p>
<p><pre class='code'><span class="Keyword">import</span> <span class="Identifier">utils</span>

<span class="Keyword">type</span>
  <span class="Identifier">Person</span> <span class="Operator">=</span> <span class="Keyword">object</span> <span class="Keyword">of</span> <span class="Identifier">Dirrty</span>
    <span class="Identifier">Fname</span><span class="Punctuation">,</span> <span class="Identifier">Fsurname</span><span class="Punctuation">:</span> <span class="Identifier">string</span>
    <span class="Identifier">Fage</span><span class="Punctuation">:</span> <span class="Identifier">int</span>

<span class="Identifier">generateProperties</span><span class="Punctuation">(</span><span class="Identifier">Person</span><span class="Punctuation">,</span> <span class="Identifier">name</span><span class="Punctuation">,</span> <span class="Identifier">string</span><span class="Punctuation">)</span>
<span class="Identifier">generateProperties</span><span class="Punctuation">(</span><span class="Identifier">Person</span><span class="Punctuation">,</span> <span class="Identifier">surname</span><span class="Punctuation">,</span> <span class="Identifier">string</span><span class="Punctuation">)</span>
<span class="Identifier">generateProperties</span><span class="Punctuation">(</span><span class="Identifier">Person</span><span class="Punctuation">,</span> <span class="Identifier">age</span><span class="Punctuation">,</span> <span class="Identifier">int</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">test</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Comment">## Exercise the setters and getters.</span>
  <span class="Keyword">var</span> <span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Identifier">Person</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">name</span> <span class="Operator">=</span> <span class="StringLit">&quot;Christina&quot;</span>
  <span class="Identifier">echo</span> <span class="StringLit">&quot;Is &quot;</span><span class="Punctuation">,</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">name</span><span class="Punctuation">,</span> <span class="StringLit">&quot; dirrty? &quot;</span><span class="Punctuation">,</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">dirrty</span>

<span class="Keyword">when</span> <span class="Identifier">isMainModule</span><span class="Punctuation">:</span> <span class="Identifier">test</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
</pre></p>
<p>This code has several issues on the long run:</p>
<ol><li>The <code>type</code> definition is separate from the <code>generateProperties()</code> calls. This means it is easy to <span style="font-style: italic;">lose sync</span> between both.</li><li>There is much repeating of simple identifiers. Worse, because the type and the property generating macro is separate, the type definition has to use the <span style="font-style: italic;">implied</span> <code>F</code> prefix for instance variables being used as properties, and the non-F version for the property (or vice versa, should you write your macro the other way round). It is easy to get distracted and mess up one or the other and later get shocked by the compiler.</li><li>Just like with the identifiers, the type for each field is repeated too. This is just nonsense. It is all you can do with C like macros though, so to the experienced C/C++ programmer it may not look <span style="font-style: italic;">that horrible</span>.</li></ol><p>With Nim you can do better. And better than the obviousness of Christina's slutdrop, I find <a href="https://en.wikipedia.org/wiki/AOA_(band)">Ace of Angels'</a> <a href="https://www.youtube.com/watch?v=q6f-LLM1H6U">miniskirt unzipping and ass shaking</a> more tasteful and pleasant to the eye (after all, at the moment I'm writing this Christina loses with 9.986.070 views to the 11.394.880 views of Ace of Angels, yet AOA's video has existed for far less time). Following the steps of these Queens Of Teasing, here is a quick peek at how the code will end up after we drive ourselves crazy with some serious macro writing:</p>
<p><pre class='code'><span class="Keyword">import</span> <span class="Identifier">utils</span>

<span class="Identifier">makeDirtyWithStyle</span><span class="Punctuation">:</span>
  <span class="Keyword">type</span>
    <span class="Identifier">Person</span> <span class="Operator">=</span> <span class="Keyword">object</span> <span class="Keyword">of</span> <span class="Identifier">Dirrty</span>
      <span class="Identifier">dirty</span><span class="Punctuation">,</span> <span class="Identifier">name</span><span class="Operator">*</span><span class="Punctuation">,</span> <span class="Identifier">surname</span><span class="Operator">*:</span> <span class="Identifier">string</span>
      <span class="Identifier">clean</span><span class="Punctuation">,</span> <span class="Identifier">age</span><span class="Operator">*:</span> <span class="Identifier">int</span>
      <span class="Identifier">internalValue</span><span class="Punctuation">:</span> <span class="Identifier">float</span>

<span class="Keyword">proc</span> <span class="Identifier">test</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Identifier">Person</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">name</span> <span class="Operator">=</span> <span class="StringLit">&quot;Christina&quot;</span>
  <span class="Identifier">echo</span> <span class="StringLit">&quot;Is &quot;</span><span class="Punctuation">,</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">name</span><span class="Punctuation">,</span> <span class="StringLit">&quot; dirrty? &quot;</span><span class="Punctuation">,</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">dirrty</span>

<span class="Keyword">when</span> <span class="Identifier">isMainModule</span><span class="Punctuation">:</span> <span class="Identifier">test</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
</pre></p>
<h1>The roadmap ahead</h1><p>We can see by the previous teaser that we got rid of the <code>generateProperties()</code> macro completely. Yay! That code has been moved into the <code>makeDirtyWithStyle()</code> macro. Instead of a call, what we are doing here is <a href="http://nim-lang.org/docs/tut2.html#macros-statement-macros">invoking our macro as a statement</a>. Everything indented after the colon will be passed in to the macro as its last parameter. How? As an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax tree</a> or AST for short.</p>

<center><a href="http://knowyourmeme.com/memes/x-x-everywhere"><img
    src="../../../i/asts-asts-everywhere.jpg"
    alt="If you close your eyes hard you can sometimes see the ASTs"
    style="width:100%;max-width:600px"
    hspace="8pt" vspace="8pt"></a></center><br><p>Our new version of the macro will still use the same <a href="http://nim-lang.org/docs/macros.html#quote">quasi-quoting</a> to generate the setter and getter procs. However, before generating any code the macro will be able to traverse the input AST and figure out itself what fields of the object are meant to be used for the setter and getter. On top of that, it will automatically mangle the fields to use the <code>F</code> prefix letter (similar to Objective-C prefixing properties with an underscore in case you need to access them directly), and we will simulate our own mini DSL through identifiers to fake language support to specify which property setters need to mark the object's dirty flag as dirty or not. You can see that in the example code through the words <code>dirty</code> and <code>clean</code>.</p>
<p>The <a href="http://nim-lang.org/docs/tut1.html">Nim Tutorial</a> has a <a href="http://nim-lang.org/docs/tut2.html#macros-building-your-first-macro">Building your first macro</a> section. You are meant to have at least skimmed through that because I won't be explaining all the basics, only the ones I'm interested in. Also, much of the typical error handling code you find in macros won't be present for brevity. What error handling code would be this? In the previous <code>generateProperties</code> version the user of this macro can pass only three very specific parameters, but in the statement version you can now pass any random Nim code to our macro, and it has to figure out how to treat it.  If the user makes any mistakes in the construct, rather than simply quitting or aborting a helpful error message should be provided. That makes the code a lot more verbose checking for all possible inputs (and you are sort of becoming a Nim compiler developer at the same time!).</p>
<p>Don't get scared now of the length of this blog post, it is all due to the example code lines being repeated several times to make the text more contextual. In any case I recommend you to either download the source code (<a href="../../../code/18/utils.nim">utils.nim</a> and <a href="../../../code/18/miniskirt.nim">miniskirt.nim</a>) or view them through GitHub, which I will use to quickly point to the appropriate lines (see <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim">utils.nim</a> and <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/miniskirt.nim">miniskirt.nim</a> on GitHub). The truth is that most of the macro is pretty simple, it has already been explained and what is left as an exercise for the writer is to transform words into code.</p>
<p>While the original and destination source code files help to get an idea of what the user will end up writing, the compiler only cares about ASTs. Just like the <a href="http://nim-lang.org/docs/tut2.html#macros-building-your-first-macro">Building your first macro</a> tutorial recommends, we can use the <a href="http://nim-lang.org/docs/macros.html#dumpTree">dumpTree() macro</a> to dump the input AST and see what the compiler is processing. For convenience, here you have the result <a href="http://nim-lang.org/docs/macros.html#dumpTree">dumpTree()</a> along the final result of <a href="http://nim-lang.org/docs/macros.html#treeRepr">treeRepr()</a> called inside the macro to show how the final AST will look <span style="font-weight: bold;">after</span> to the compiler. The input AST is on the left, the final AST is on the right. Additional unicode numbered markers have been placed to point out the interesting parts:<pre class='literal'>
type
  Person = object of Dirrty
    dirty ①, name* ②, surname* ②: string
    clean ①, age* ②: int
    internalValue ③: float
----
StmtList                   StmtList
  TypeSection                TypeSection
    TypeDef                    TypeDef
      Ident !&quot;Person&quot;            Ident !&quot;Person&quot;
      Empty                      Empty
      ObjectTy                   ObjectTy
        Empty                      Empty
        OfInherit                  OfInherit
          Ident !&quot;Dirrty&quot;            Ident !&quot;Dirrty&quot;
        RecList                    RecList
          IdentDefs                  IdentDefs
            Ident !&quot;dirty&quot;             ①
            Postfix                    Postfix
              Ident !&quot;*&quot;                 Ident !&quot;*&quot;
              Ident !&quot;name&quot;              Ident !&quot;Fname&quot; ②
            Postfix                    Postfix
              Ident !&quot;*&quot;                 Ident !&quot;*&quot;
              Ident !&quot;surname&quot;           Ident !&quot;Fsurname&quot; ②
            Ident !&quot;string&quot;            Ident !&quot;string&quot;
            Empty                      Empty
          IdentDefs                  IdentDefs
            Ident !&quot;clean&quot;             ①
            Postfix                    Postfix
              Ident !&quot;*&quot;                 Ident !&quot;*&quot;
              Ident !&quot;age&quot;               Ident !&quot;Fage&quot; ②
            Ident !&quot;int&quot;               Ident !&quot;int&quot;
            Empty                      Empty
          IdentDefs                  IdentDefs ③
            Ident !&quot;internalValue&quot;     Ident !&quot;internalValue&quot;
            Ident !&quot;float&quot;             Ident !&quot;float&quot;
            Empty                      Empty</pre></p>
<ol><li>The <code>dirty</code> and <code>clean</code> identifiers are removed from the right AST. They are not used by the compiler, they are markers our macro uses to modify the behaviour of the proc generating code.</li><li>The fields marked as properties will be mangled in the final tree to contain the prefix <code>F</code> letter. Note how all the identifiers on each line get mangled, we have to control this too. And remember that the last identifier is the type which we should not touch!</li><li>In this example, any list of identifiers starting with the identifier <code>dirty</code> or <code>clean</code>  will be mangled into a property. The <code>internalValue</code> is there precisely to test that we don't generate a property for it. As you can see it is identical to the left AST.</li></ol><p>For the purpose of making our macro traversing code more resilient (and fun!) this version of the example includes the <code>*</code> postfix operator, which is used in Nim to <span style="font-style: italic;">export</span> symbols out of the module's scope. Not required for the small example to work, it is something very common our macro would find in the real world. Our version will deal with it correctly when traversing the AST but we won't be using it to change the visibility of the procs generated for each property for brevity (it's quite easy to add but increases the verbosity of the example, and its already quite long as it is).</p>
<p>What is missing in this AST is that the right version will be followed with a lot of proc definitions which are generated to emulate the Objective-C like properties. This would be the output from our previous <code>generateProperties()</code> macro but is not particularly interesting in itself and only adds line noise so it has not been included in this AST representation.</p>
<h1>Row, row, row your AST…</h1><p>Let's start then with the <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L118">makeDirtyWithStyle()</a> macro:</p>
<p><pre class='code'><span class="Keyword">macro</span> <span class="Identifier">makeDirtyWithStyle</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">body</span><span class="Punctuation">:</span> <span class="Identifier">stmt</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">stmt</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">immediate</span><span class="Operator">.</span><span class="Punctuation">}</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">foundObjects</span> <span class="Operator">=</span> <span class="Identifier">initTable</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">,</span> <span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">procTuple</span><span class="Punctuation">]</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
  <span class="Comment"># Find and mangle</span>
  <span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">body</span><span class="Operator">.</span><span class="Identifier">children</span><span class="Punctuation">:</span>
    <span class="Keyword">if</span> <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">kind</span> <span class="Operator">!=</span> <span class="Identifier">nnkTypeSection</span><span class="Punctuation">:</span> <span class="Keyword">continue</span>
    <span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">children</span><span class="Punctuation">:</span>
      <span class="Keyword">if</span> <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">kind</span> <span class="Operator">!=</span> <span class="Identifier">nnkTypeDef</span><span class="Punctuation">:</span> <span class="Keyword">continue</span>
      <span class="Keyword">let</span>
        <span class="Identifier">typeName</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">n</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">]</span>
        <span class="Identifier">typeNode</span> <span class="Operator">=</span> <span class="Identifier">n</span><span class="Punctuation">[</span><span class="DecNumber">2</span><span class="Punctuation">]</span>
      <span class="Keyword">if</span> <span class="Identifier">typeNode</span><span class="Operator">.</span><span class="Identifier">kind</span> <span class="Operator">!=</span> <span class="Identifier">nnkObjectTy</span><span class="Punctuation">:</span> <span class="Keyword">continue</span>
      <span class="Keyword">let</span> <span class="Identifier">mangledObject</span> <span class="Operator">=</span> <span class="Identifier">n</span><span class="Punctuation">[</span><span class="DecNumber">2</span><span class="Punctuation">]</span><span class="Operator">.</span><span class="Identifier">rewriteObject</span>
      <span class="Identifier">n</span><span class="Punctuation">[</span><span class="DecNumber">2</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">mangledObject</span><span class="Operator">.</span><span class="Identifier">node</span>
      <span class="Comment"># Store the found symbols for a second proc phase.</span>
      <span class="Keyword">if</span> <span class="Identifier">mangledObject</span><span class="Operator">.</span><span class="Identifier">found</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">&gt;</span> <span class="DecNumber">0</span><span class="Punctuation">:</span>
        <span class="Identifier">foundObjects</span><span class="Punctuation">[</span><span class="Identifier">typeName</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">mangledObject</span><span class="Operator">.</span><span class="Identifier">found</span>
  
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Identifier">body</span>
  <span class="Comment"># Iterate through fields and generate property procs.</span>
  <span class="Keyword">for</span> <span class="Identifier">objectName</span><span class="Punctuation">,</span> <span class="Identifier">mangledSymbols</span> <span class="Keyword">in</span> <span class="Identifier">foundObjects</span><span class="Operator">.</span><span class="Identifier">pairs</span><span class="Punctuation">:</span>
    <span class="Keyword">for</span> <span class="Identifier">dirty</span><span class="Punctuation">,</span> <span class="Identifier">name</span><span class="Punctuation">,</span> <span class="Identifier">typ</span> <span class="Keyword">in</span> <span class="Identifier">mangledSymbols</span><span class="Operator">.</span><span class="Identifier">items</span><span class="Punctuation">:</span>
      <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">add</span><span class="Punctuation">(</span><span class="Identifier">generateProperties</span><span class="Punctuation">(</span><span class="Identifier">dirty</span><span class="Punctuation">,</span>
        <span class="Identifier">objectName</span><span class="Punctuation">,</span> <span class="Identifier">name</span><span class="Punctuation">,</span> <span class="Identifier">typ</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
</pre></p>
<p>The macro has two clear parts: iterating through the AST looking for <code>foundObjects</code>, and then looping over the found results to call the <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L87">generateProperties()</a> helper. During the search we also modify the <code>body</code> to remove some identifiers and prefix others with the letter <code>F</code>. This is fine with the compiler. If the macro doesn't find any object to mangle, the <code>result = body</code> line will essentially pass the user input raw to the compiler, plus the following loop won't do anything. The <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L87">generateProperties()</a> helper is nearly intact from the previous article, the only modification has been to add the <code>dirty</code> parameter. With this parameter we specify if we want the generated setter to set the <code>dirrty</code> field to <code>true</code>, which allows us to generate setters which don't modify the <code>dirrty</code> state of the object.</p>
<p>Traversing the AST is quite easy, first we check that we are inside a <code>nnkTypeSection</code>. Inside this node, we continue to go deeper until we find a <code>nnkTypeDef</code> node, which is what we wanted in first place. The user could be defining types <span style="font-weight: bold;">other</span> than objects. For instance, they could be defining a <code>tuple</code> along their object. So we are only interested in <code>nnkObjectTy</code> nodes. Finally, we call the <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L54">rewriteObject()</a> helper proc which returns the mangled AST node plus a sequence of <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L17">procTuple</a> elements which contain what fields need to be mangled. Maybe the object had none, so we check for the length of the <code>mangledObject.found</code> list before doing anything. Still, we can happily replace the AST node with the returned value (<code>n[2] = mangledObject.node</code>) because it won't have changed at all.</p>
<p>So what does the <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L54">rewriteObject()</a> helper do?</p>
<p><pre class='code'><span class="Keyword">proc</span> <span class="Identifier">rewriteObject</span><span class="Punctuation">(</span><span class="Identifier">parentNode</span><span class="Punctuation">:</span> <span class="Identifier">PNimrodNode</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">rewriteTuple</span> <span class="Operator">=</span>
  <span class="Comment"># Create a copy which we will modify and return.</span>
  <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">node</span> <span class="Operator">=</span> <span class="Identifier">copyNimTree</span><span class="Punctuation">(</span><span class="Identifier">parentNode</span><span class="Punctuation">)</span>
  <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">found</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="Punctuation">]</span>
  
  <span class="Comment"># Ignore the object unless it inherits from Dirrty.</span>
  <span class="Keyword">let</span> <span class="Identifier">inheritanceNode</span> <span class="Operator">=</span> <span class="Identifier">parentNode</span><span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">]</span>
  <span class="Keyword">if</span> <span class="Identifier">inheritanceNode</span><span class="Operator">.</span><span class="Identifier">kind</span> <span class="Operator">!=</span> <span class="Identifier">nnkOfInherit</span><span class="Punctuation">:</span>
    <span class="Keyword">return</span>
  <span class="Identifier">inheritanceNode</span><span class="Operator">.</span><span class="Identifier">expectMinLen</span><span class="Punctuation">(</span><span class="DecNumber">1</span><span class="Punctuation">)</span>
  <span class="Keyword">if</span> <span class="Operator">$</span><span class="Identifier">inheritanceNode</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">]</span> <span class="Operator">!=</span> <span class="StringLit">&quot;Dirrty&quot;</span><span class="Punctuation">:</span>
    <span class="Keyword">return</span>
  
  <span class="Comment"># Get the list of records for the object.</span>
  <span class="Keyword">var</span> <span class="Identifier">recList</span> <span class="Operator">=</span> <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">node</span><span class="Punctuation">[</span><span class="DecNumber">2</span><span class="Punctuation">]</span>
  <span class="Keyword">if</span> <span class="Identifier">recList</span><span class="Operator">.</span><span class="Identifier">kind</span> <span class="Operator">!=</span> <span class="Identifier">nnkRecList</span><span class="Punctuation">:</span>
    <span class="Identifier">error</span> <span class="StringLit">&quot;Was expecting a record list&quot;</span>
  <span class="Keyword">for</span> <span class="Identifier">nodeIndex</span> <span class="Keyword">in</span> <span class="DecNumber">0</span> <span class="Operator">..</span> <span class="Operator">&lt;</span><span class="Identifier">recList</span><span class="Operator">.</span><span class="Identifier">len</span><span class="Punctuation">:</span>
    <span class="Keyword">var</span> <span class="Identifier">idList</span> <span class="Operator">=</span> <span class="Identifier">recList</span><span class="Punctuation">[</span><span class="Identifier">nodeIndex</span><span class="Punctuation">]</span>
    <span class="Comment"># Only mutate those which start with fake keywords.</span>
    <span class="Keyword">let</span> <span class="Identifier">firstRawName</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">basename</span><span class="Punctuation">(</span><span class="Identifier">idList</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
    <span class="Keyword">if</span> <span class="Identifier">firstRawName</span> <span class="Keyword">in</span> <span class="Punctuation">[</span><span class="StringLit">&quot;clean&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;dirty&quot;</span><span class="Punctuation">]</span><span class="Punctuation">:</span>
      <span class="Keyword">var</span> <span class="Identifier">found</span><span class="Punctuation">:</span> <span class="Identifier">procTuple</span>
      <span class="Identifier">found</span><span class="Operator">.</span><span class="Identifier">dirty</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Identifier">firstRawName</span> <span class="Operator">==</span> <span class="StringLit">&quot;dirty&quot;</span><span class="Punctuation">)</span>
      <span class="Identifier">del</span><span class="Punctuation">(</span><span class="Identifier">idList</span><span class="Punctuation">)</span> <span class="Comment"># Removes the first identifier.</span>
      <span class="Identifier">found</span><span class="Operator">.</span><span class="Identifier">typ</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">idList</span><span class="Punctuation">[</span><span class="Identifier">idlist</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">-</span> <span class="DecNumber">2</span><span class="Punctuation">]</span>
      <span class="Comment"># Get the identifiers.</span>
      <span class="Keyword">for</span> <span class="Identifier">identifier</span> <span class="Keyword">in</span> <span class="Identifier">idList</span><span class="Operator">.</span><span class="Identifier">stripTypeIdentifier</span><span class="Punctuation">:</span>
        <span class="Identifier">found</span><span class="Operator">.</span><span class="Identifier">name</span> <span class="Operator">=</span> <span class="Identifier">identifier</span>
        <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">found</span><span class="Operator">.</span><span class="Identifier">add</span><span class="Punctuation">(</span><span class="Identifier">found</span><span class="Punctuation">)</span>
      <span class="Comment"># Mangle the remaining identifiers</span>
      <span class="Identifier">idList</span><span class="Operator">.</span><span class="Identifier">prefixIdentifiersWithF</span>
</pre></p>
<p>The first line which calls <a href="http://nim-lang.org/docs/macros.html#copyNimTree">copyNimTree()</a> is not strictly needed, but can be useful in case we would need to do multiple passes on the AST and have to compare our working version with the original one. Then we make sure the object type definition we are dealing with actually inherits from our custom <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L14">Dirrty</a> object. This means we won't get automatic properties on objects which inherit from other classes. Alternatively, we could detect this case and prevent the generated setter from attempting to modify the field <code>dirrty</code> which won't be present. I've decided to only add properties to dirrty objects for clarity (otherwise it's just a matter of more <code>ifs</code> in the following lines).</p>
<p>When we deal with the identifier record list what we do is detect if the first identifier is <code>clean</code> or <code>dirty</code>. These are our <span style="font-style: italic;">fake</span> DSL keywords which tell the macro that the remaining fields need to be mangled. If the found keyword is <code>dirty</code>, the generated setter will modify the <code>dirrty</code> field, but otherwise the rest of the code is quite similar. In any case we remove the first fake identifier, then we loop over the remaining identifiers modifying our <code>var found: procTuple</code> with the name and adding a copy to the <code>result.found</code> sequence. For this loop the <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L24">stripTypeIdentifier()</a> helper is used which simply iterates through the list of identifiers (except the last one, which is the type definition!) and returns them as strings:</p>
<p><pre class='code'><span class="Keyword">proc</span> <span class="Identifier">stripTypeIdentifier</span><span class="Punctuation">(</span><span class="Identifier">identDefsNode</span><span class="Punctuation">:</span> <span class="Identifier">PNimrodNode</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
    <span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span> <span class="Operator">=</span>
  <span class="Comment"># Returns the names minus the type from an identifier list.</span>
  <span class="Identifier">identDefsNode</span><span class="Operator">.</span><span class="Identifier">expectMinLen</span><span class="Punctuation">(</span><span class="DecNumber">3</span><span class="Punctuation">)</span>
  <span class="Keyword">let</span> <span class="Identifier">last</span> <span class="Operator">=</span> <span class="Identifier">identDefsNode</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">-</span> <span class="DecNumber">1</span>
  <span class="Identifier">identDefsNode</span><span class="Punctuation">[</span><span class="Identifier">last</span><span class="Punctuation">]</span><span class="Operator">.</span><span class="Identifier">expectKind</span><span class="Punctuation">(</span><span class="Identifier">nnkEmpty</span><span class="Punctuation">)</span>
  <span class="Identifier">identDefsNode</span><span class="Punctuation">[</span><span class="Identifier">last</span> <span class="Operator">-</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Operator">.</span><span class="Identifier">expectKind</span><span class="Punctuation">(</span><span class="Identifier">nnkIdent</span><span class="Punctuation">)</span>
  
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="Punctuation">]</span>
  <span class="Keyword">for</span> <span class="Identifier">i</span> <span class="Keyword">in</span> <span class="DecNumber">0</span> <span class="Operator">..</span> <span class="Operator">&lt;</span><span class="Identifier">last</span> <span class="Operator">-</span> <span class="DecNumber">1</span><span class="Punctuation">:</span>
    <span class="Keyword">let</span> <span class="Identifier">n</span> <span class="Operator">=</span> <span class="Identifier">identDefsNode</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">]</span>
    <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">add</span><span class="Punctuation">(</span><span class="Operator">$</span><span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">basename</span><span class="Punctuation">)</span>
</pre></p>
<p>Once the identifiers without mangling have been added to the list of found fields we pass control to the <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L47">prefixIdentifiersWithF()</a> helper proc to actually mangle them with the <code>F</code> prefix:</p>
<p><pre class='code'><span class="Keyword">proc</span> <span class="Identifier">prefixNode</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">:</span> <span class="Identifier">PNimrodNode</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">PNimrodNode</span> <span class="Operator">=</span>
  <span class="Comment"># Returns the ident node with a prefix F.</span>
  <span class="Keyword">case</span> <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">kind</span>
  <span class="Keyword">of</span> <span class="Identifier">nnkIdent</span><span class="Punctuation">:</span> <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Identifier">ident</span><span class="Punctuation">(</span><span class="StringLit">&quot;F&quot;</span> <span class="Operator">&amp;</span> <span class="Operator">$</span><span class="Identifier">n</span><span class="Punctuation">)</span>
  <span class="Keyword">of</span> <span class="Identifier">nnkPostfix</span><span class="Punctuation">:</span>
    <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">copyNimTree</span>
    <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">basename</span> <span class="Operator">=</span> <span class="StringLit">&quot;F&quot;</span> <span class="Operator">&amp;</span> <span class="Operator">$</span><span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">basename</span>
  <span class="Keyword">else</span><span class="Punctuation">:</span>
    <span class="Identifier">error</span> <span class="StringLit">&quot;Don't know how to prefix &quot;</span> <span class="Operator">&amp;</span> <span class="Identifier">treeRepr</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">prefixIdentifiersWithF</span><span class="Punctuation">(</span><span class="Identifier">identDefsNode</span><span class="Punctuation">:</span> <span class="Identifier">PNimrodNode</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Comment"># Replace all nodes except last with F version.</span>
  <span class="Keyword">let</span> <span class="Identifier">last</span> <span class="Operator">=</span> <span class="Identifier">identDefsNode</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">-</span> <span class="DecNumber">1</span>
  <span class="Keyword">for</span> <span class="Identifier">i</span> <span class="Keyword">in</span> <span class="DecNumber">0</span> <span class="Operator">..</span> <span class="Operator">&lt;</span><span class="Identifier">last</span> <span class="Operator">-</span> <span class="DecNumber">1</span><span class="Punctuation">:</span>
    <span class="Keyword">let</span> <span class="Identifier">n</span> <span class="Operator">=</span> <span class="Identifier">identDefsNode</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">]</span>
    <span class="Identifier">identDefsNode</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">prefixNode</span>
</pre></p>
<p>As you can see <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L47">prefixIdentifiersWithF()</a> is pretty similar to <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L24">stripTypeIdentifier()</a>, but instead of adding the identifier to a result list it calls the <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L37">prefixNode()</a> helper which mangles the node identifier. Here you can see us dealing with <code>nnkPostfix</code> nodes, which are fields marked with <code>*</code>. Again, as mentioned above, we could detect which of the fields are marked with <code>*</code> to propagate the appropriate symbol visibility to the generated property procs.  This is left as an exercise to the reader (hint: add a visibility field to <code>procTuple</code> which already contains other field info).</p>
<p>For completeness, the snippets of code shown so far use two types which haven't been defined, <code>rewriteTuple</code> and <code>procTuple</code>:</p>
<p><pre class='code'><span class="Keyword">type</span>
  <span class="Identifier">procTuple</span> <span class="Operator">=</span>
    <span class="Keyword">tuple</span><span class="Punctuation">[</span><span class="Identifier">dirty</span><span class="Punctuation">:</span> <span class="Identifier">bool</span><span class="Punctuation">,</span> <span class="Identifier">name</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">,</span> <span class="Identifier">typ</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">]</span>
  
  <span class="Identifier">rewriteTuple</span> <span class="Operator">=</span>
    <span class="Keyword">tuple</span><span class="Punctuation">[</span><span class="Identifier">node</span><span class="Punctuation">:</span> <span class="Identifier">PNimrodNode</span><span class="Punctuation">,</span> <span class="Identifier">found</span><span class="Punctuation">:</span> <span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">procTuple</span><span class="Punctuation">]</span><span class="Punctuation">]</span>
</pre></p>
<p>Nothing too fancy, they are just the internal structures used to group and communicate results between the procs. And… that's all folks! To verify everything is working as expected, here is an <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/miniskirt.nim#L15">extended version of our original property usage test case</a>:</p>
<p><pre class='code'><span class="Keyword">proc</span> <span class="Identifier">extraTest</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Identifier">Person</span>
  <span class="Identifier">echo</span> <span class="StringLit">&quot;Doing now extra test&quot;</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">name</span> <span class="Operator">=</span> <span class="StringLit">&quot;Christina&quot;</span>
  <span class="Identifier">echo</span> <span class="StringLit">&quot;Is &quot;</span><span class="Punctuation">,</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">name</span><span class="Punctuation">,</span> <span class="StringLit">&quot; dirrty? &quot;</span><span class="Punctuation">,</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">dirrty</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">dirrty</span> <span class="Operator">=</span> <span class="Identifier">false</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">age</span> <span class="Operator">=</span> <span class="DecNumber">18</span>
  <span class="Identifier">echo</span> <span class="StringLit">&quot;Is &quot;</span><span class="Punctuation">,</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">name</span><span class="Punctuation">,</span> <span class="StringLit">&quot; with &quot;</span><span class="Punctuation">,</span> <span class="Operator">$</span><span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">age</span><span class="Punctuation">,</span> <span class="StringLit">&quot; years dirrty? &quot;</span><span class="Punctuation">,</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">dirrty</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">internalValue</span> <span class="Operator">=</span> <span class="FloatNumber">3.14</span>
  <span class="Identifier">echo</span> <span class="StringLit">&quot;And after changing the internal value? &quot;</span><span class="Punctuation">,</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">dirrty</span>
  <span class="Comment"># --&gt; Doing now extra test</span>
  <span class="Comment">#     Is Christina dirrty? true</span>
  <span class="Comment">#     Is Christina with 18 years dirrty? false</span>
  <span class="Comment">#     And after changing the internal value? false</span>
</pre></p>
<p>In this version of the test we repeat the original dirtying of the <code>Person</code> object through the generated <code>name=()</code> setter, which modifies the <code>dirrty</code> field. Then, we reset the <code>dirrty</code>  field and modify the age. The modification of the <code>age</code> property uses also a setter, but since this one was marked as <code>clean</code> the <code>dirrty</code> field won't change its value. Finally, we modify the <code>internalValue</code>. This value was not marked with our fake keywords, so the macro won't be generating any setter or getter. How can we verify this? We could modify our macro to dump the final AST after the generated procs are added. We can also inspect our <code>nimcache</code> folder which <a href="http://nim-lang.org/docs/backends.html#interfacing-nimcache-naming-logic">should contain the generated C files</a>. In my case this is part of the generated code for the <code>extraTest()</code> proc:</p>
<p><pre class='code'><span class="Punctuation">.</span><span class="Punctuation">.</span><span class="Punctuation">.</span>
    <span class="Identifier">nimln</span><span class="Punctuation">(</span><span class="DecNumber">22</span><span class="Punctuation">,</span> <span class="StringLit">&quot;miniskirt.nim&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">nimln</span><span class="Punctuation">(</span><span class="DecNumber">22</span><span class="Punctuation">,</span> <span class="StringLit">&quot;miniskirt.nim&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">LOC4</span> <span class="Operator">=</span> <span class="DecNumber">0</span><span class="Punctuation">;</span>
    <span class="Identifier">LOC4</span> <span class="Operator">=</span> <span class="Identifier">age_111032</span><span class="Punctuation">(</span><span class="Operator">&amp;</span><span class="Identifier">a</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">LOC5</span> <span class="Operator">=</span> <span class="DecNumber">0</span><span class="Punctuation">;</span>
    <span class="Identifier">LOC5</span> <span class="Operator">=</span> <span class="Identifier">nimIntToStr</span><span class="Punctuation">(</span><span class="Identifier">LOC4</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">nimln</span><span class="Punctuation">(</span><span class="DecNumber">22</span><span class="Punctuation">,</span> <span class="StringLit">&quot;miniskirt.nim&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">LOC6</span> <span class="Operator">=</span> <span class="DecNumber">0</span><span class="Punctuation">;</span>
    <span class="Identifier">LOC6</span> <span class="Operator">=</span> <span class="Identifier">nimBoolToStr</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">Sup</span><span class="Punctuation">.</span><span class="Identifier">Dirrty</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">printf</span><span class="Punctuation">(</span><span class="StringLit">&quot;%s%s%s%s%s%s</span><span class="EscapeSequence">\012</span><span class="StringLit">&quot;</span><span class="Punctuation">,</span>
        <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">NimStringDesc</span><span class="Operator">*</span><span class="Punctuation">)</span> <span class="Operator">&amp;</span><span class="Identifier">TMP230</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Operator">-&gt;</span><span class="Identifier">data</span><span class="Punctuation">,</span>
        <span class="Punctuation">(</span><span class="Identifier">LOC3</span><span class="Punctuation">)</span><span class="Operator">-&gt;</span><span class="Identifier">data</span><span class="Punctuation">,</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">NimStringDesc</span><span class="Operator">*</span><span class="Punctuation">)</span> <span class="Operator">&amp;</span><span class="Identifier">TMP233</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Operator">-&gt;</span><span class="Identifier">data</span><span class="Punctuation">,</span>
        <span class="Punctuation">(</span><span class="Identifier">LOC5</span><span class="Punctuation">)</span><span class="Operator">-&gt;</span><span class="Identifier">data</span><span class="Punctuation">,</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">NimStringDesc</span><span class="Operator">*</span><span class="Punctuation">)</span> <span class="Operator">&amp;</span><span class="Identifier">TMP234</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Operator">-&gt;</span><span class="Identifier">data</span><span class="Punctuation">,</span>
        <span class="Punctuation">(</span><span class="Identifier">LOC6</span><span class="Punctuation">)</span><span class="Operator">-&gt;</span><span class="Identifier">data</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">nimln</span><span class="Punctuation">(</span><span class="DecNumber">23</span><span class="Punctuation">,</span> <span class="StringLit">&quot;miniskirt.nim&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">Internalvalue</span> <span class="Operator">=</span> <span class="FloatNumber">3.1400000000000001e+00</span><span class="Punctuation">;</span>
    <span class="Identifier">nimln</span><span class="Punctuation">(</span><span class="DecNumber">24</span><span class="Punctuation">,</span> <span class="StringLit">&quot;miniskirt.nim&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">nimln</span><span class="Punctuation">(</span><span class="DecNumber">24</span><span class="Punctuation">,</span> <span class="StringLit">&quot;miniskirt.nim&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">LOC7</span> <span class="Operator">=</span> <span class="DecNumber">0</span><span class="Punctuation">;</span>
    <span class="Identifier">LOC7</span> <span class="Operator">=</span> <span class="Identifier">nimBoolToStr</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">.</span><span class="Identifier">Sup</span><span class="Punctuation">.</span><span class="Identifier">Dirrty</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">printf</span><span class="Punctuation">(</span><span class="StringLit">&quot;%s%s</span><span class="EscapeSequence">\012</span><span class="StringLit">&quot;</span><span class="Punctuation">,</span>
        <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">NimStringDesc</span><span class="Operator">*</span><span class="Punctuation">)</span> <span class="Operator">&amp;</span><span class="Identifier">TMP235</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Operator">-&gt;</span><span class="Identifier">data</span><span class="Punctuation">,</span> <span class="Punctuation">(</span><span class="Identifier">LOC7</span><span class="Punctuation">)</span><span class="Operator">-&gt;</span><span class="Identifier">data</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">popFrame</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Punctuation">.</span><span class="Punctuation">.</span><span class="Punctuation">.</span>
</pre></p>
<p>While there is much low level and debug keeping stuff, note how the modification of the age invokes the <code>LOC4 = age_111032(&amp;a);</code> function call (our custom generated setter), while the modification of the <code>internalValue</code> doesn't do any call, simply assigns with <code>a.Internalvalue = 3.1400000000000001e+00;</code>. That means we have successfully created a property generation macro, with cool fake pseudo keywords, and it works exactly were we want it to work! That's a great deal better than simple C preprocessor macros.</p>
<h1>Looking under the rug</h1><p>While we have accomplished what we wanted (cooler Objective-C property like generation code in Nim), there are still some rough edges we can't deal with, or annoying stuff which hopefully will be improved in future versions of Nim. From our user perspective, to the left you can see the code we now can write. To the right you can see what could be written if the language provided native property support (which is impossible, or do you know of any language providing built-in object dirty field tracking?):<pre class='literal'>
makeDirtyWithStyle:                  dirtyType:
  type                                 Person = object of Dirrty
    Person = object of Dirrty            dirtyProperties:
      dirty, name*, surname*: string         name*, surname*: string
      clean, age*: int                   cleanProperties:
      internalValue: float                   age*: int
                                         privateFields:
                                             internalValue: float</pre></p>
<p>If we had our way and our hypothetical language would implement this feature directly, we could mark our objects directly with <code>dirtyProperties</code>, <code>cleanProperties</code> and <code>privateFields</code> sections. These would be recognised as keywords by IDEs and editors. We have to settle for fake identifiers. It's not bad, but could be worse. What is more annoying is that we can't get rid of the explicit <code>type</code> keyword. Why? Because the Nim compiler still has to parse that code into <span style="font-weight: bold;">VALID AST</span> before it can pass it to our macro. And it is the <code>type</code> keyword which tells the parser that what follows should be treated as a <code>TypeSection</code> with <code>TypeDef</code> and other stuff instead of say, a <code>proc</code> definition. Here you can hear lisp programmers laughing at our puny syntax limitations. Still, Nim achieves the power of true macros with little limitations. Would it be possible for Nim (or just any other language) to allow user code extend the compiler parser with custom DSL rules? I think that would be neat. And madness. Madness is neat, I'm still patiently waiting for macros which modify the AST of the caller to the shock and horror of anybody reading my code…</p>
<p>Possibly the most frustrating issue with writing Nim macros now is the lack of proper documentation. While there is that <a href="http://nim-lang.org/docs/tut2.html#macros-building-your-first-macro">introductory tutorial</a>, the <a href="http://nim-lang.org/docs/macros.html">macros module API</a> seems to have more sections filled with <code>To be written</code> than actual text, and many of the actual descriptions are rather useless to newcomers (don't tell me <a href="http://nim-lang.org/docs/macros.html#newEmptyNode">newEmptyNode()</a> creates an empty node, tell me in what situations I would like that, or how do I use the result with other procs!). It's not a surprise that one of the past enhancements to the documentation generator was to add the <code>See source</code> link, it's nearly the only crutch you have to figure out how to do stuff (and that's if you figure out what each proc does).</p>
<p>One more annoying issue is the lack of helpful stack traces during AST error handling, which can happen a lot when developing macros. When you are writing normal code, you get runtime stack traces which show where the execution of the program was and hopefully by going to the mentioned lines you can fix something to keep going. I present you the most useless stack trace <span style="font-weight: bold;">from hell</span>:<pre class='literal'>
miniskirt.nim(3, 0) Info: instantiation from here
???(???, ???) Error: type expected</pre></p>

<center><a href="http://www.idol-grapher.com/1239"><img
    src="../../../i/error-type-expected.jpg"
    alt="Error: type expected"
    style="width:100%;max-width:600px"
    hspace="8pt" vspace="8pt"></a></center><br><p>That's it. Nothing more. It's actually pretty awesome, can't do better short of pulling out a gun and shooting you right in the face. Let me tell you how to reproduce this, just comment the <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L91">objType assignment</a> in the <a href="https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L87">generateProperties()</a> static proc, like this:</p>
<p><pre class='code'><span class="Keyword">proc</span> <span class="Identifier">generateProperties</span><span class="Punctuation">(</span><span class="Identifier">dirrty</span><span class="Punctuation">:</span> <span class="Identifier">bool</span><span class="Punctuation">,</span> <span class="Identifier">objType</span><span class="Punctuation">,</span>
      <span class="Identifier">varName</span><span class="Punctuation">,</span> <span class="Identifier">varType</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">PNimrodNode</span> <span class="Operator">=</span>
    <span class="Comment"># Create identifiers from the parameters.</span>
    <span class="Keyword">let</span>
      <span class="Comment">#objType = !(objType)</span>
      <span class="Identifier">varType</span> <span class="Operator">=</span> <span class="Operator">!</span><span class="Punctuation">(</span><span class="Identifier">varType</span><span class="Punctuation">)</span>
      <span class="Identifier">setter</span> <span class="Operator">=</span> <span class="Operator">!</span><span class="Punctuation">(</span><span class="Operator">$</span><span class="Identifier">varName</span> <span class="Operator">&amp;</span> <span class="StringLit">&quot;=&quot;</span><span class="Punctuation">)</span>
</pre> This error happens because the <code>objType</code> is a string literal, but instead of a string literal the <code>quasi-quoting</code> macro needs a <code>TNimrodIdent</code>, which is obtained through the <a href="http://nim-lang.org/docs/macros.html#!,string">!() operator</a>. That's why removing this re-assignment breaks everything and you are left wondering <span style="font-weight: bold;">where to start looking for problems because there is no starting point at all</span>. And unfortunately it can't be fixed easily. By the time the compiler goes through the quasi-quoting it doesn't know better if what it is generating is right or wrong, and by the time it reaches a further phase of the compiler, since it was all generated code, there are no actual line numbers to keep track of what was generated where.</p>
<p>How could this be improved? Maybe the <a href="http://nim-lang.org/docs/macros.html">macros</a> module could grow an <code>annotateNode</code> helper which when used would annotate the specified node with the current line/column where the <code>annotateNode</code> helper actually is in the source file. Kind of like <code>printf</code> cavemen debugging. Or maybe instead of trying to preserve stack traces which are typical of runtime environments the compiler could actually dump the AST it is processing with a little arrow pointing at the node that is giving problems? Honestly, if instead of this error I had gotten the AST with an arrow pointing at the string literal I would at least know where to start looking at, even if by the mere AST I still might have trouble finding out why a string literal is not expected. But you would at least have a starting point. The ASTs can get quite big, so it would help if the compiler could dump the problematic AST to a temporary file for inspection with an editor rather than scrolling through pages of terminal output.</p>
<p>Talking about cavemen debugging, the only sources of information you have now for development of macros are the <a href="http://nim-lang.org/docs/macros.html#dumpTree">dumpTree()</a> and <a href="http://nim-lang.org/docs/macros.html#treeRepr">treeRepr()</a> helpers and repeated trips to the command line to compile stuff. It would be really nice if the <a href="https://github.com/nim-lang/Aporia">official Nim IDE Aporia</a> had a mode where you could open a bit of code in a separate window and it would refresh the AST as you write, pointing at problematic places, or maybe offering links to the documentation as you write code. Or maybe a mode where you directly write the AST, and the IDE generates the source code for you? Maybe this could work off with proper auto completion. Right now the amount of different AST nodes is quite scary but many of them don't interact with each other unless specific conditions are met.  Who knows, it could be easier to follow than looking through the documentation. Or maybe it would be useless anyway because programming in Java is all the rage.</p>
<h1>Conclusion</h1><p><a href="http://www.youtube.com/watch?v=-i_2DIGBmO4">Even</a> <a href="http://www.youtube.com/watch?v=-uZj3EVuSiM">with</a> <a href="http://www.youtube.com/watch?v=1KMF2cDG-Aw">the</a> <a href="http://www.youtube.com/watch?v=22vDm0JSc7E">rough</a> <a href="http://www.youtube.com/watch?v=27Cs_W5EptU">edges,</a> <a href="http://www.youtube.com/watch?v=2KYQH2a5u-Y">expected</a> <a href="http://www.youtube.com/watch?v=2KtflWoHIeE">in</a> <a href="http://www.youtube.com/watch?v=2TxSSILNibY">a</a> <a href="http://www.youtube.com/watch?v=2w-nmLcZUFA">programming</a> <a href="http://www.youtube.com/watch?v=2x_4Odo8BzI">language</a> <a href="http://www.youtube.com/watch?v=39B3AeTD0lY">which</a> <a href="http://www.youtube.com/watch?v=7HFwjrrPx7A">hasn't</a> <a href="http://www.youtube.com/watch?v=43dbZq6bv1o">yet</a> <a href="http://www.youtube.com/watch?v=4ZBDWpneAgw">reached</a> <a href="http://www.youtube.com/watch?v=4oL9XLCktOQ">version</a> <a href="http://www.youtube.com/watch?v=58xk5L5pCMg">1.0</a> <a href="http://www.youtube.com/watch?v=5P7QGBIFAgo">and</a> <a href="http://www.youtube.com/watch?v=EZ487LebWt8">is</a> <a href="http://www.youtube.com/watch?v=6JhZhMYx780">already</a> <a href="http://www.youtube.com/watch?v=6_HHut7u29w">running</a> <a href="http://www.youtube.com/watch?v=6hqSmVRXwTE">circles</a> <a href="http://www.youtube.com/watch?v=85kgIuq3HY4">around</a> <a href="http://www.youtube.com/watch?v=1xKE1H8BXmE">established</a> <a href="http://www.youtube.com/watch?v=9g2YPmzDfkI">programming</a> <a href="http://www.youtube.com/watch?v=A_MCEHd6now">languages,</a> <a href="http://www.youtube.com/watch?v=Ac7SN63L6po">macros</a> <a href="http://www.youtube.com/watch?v=B99pOzAfFy4">are</a> <a href="http://www.youtube.com/watch?v=BygwsVYUbO8">a</a> <a href="http://www.youtube.com/watch?v=CTAAn5vbVPs">complete</a> <a href="http://www.youtube.com/watch?v=D0TkSCpBSc0">win</a> <a href="http://www.youtube.com/watch?v=DBNAWLlPxCY">for</a> <a href="http://www.youtube.com/watch?v=DO8SJ2uxV4s">programming.</a> <a href="http://www.youtube.com/watch?v=Dgwth72XZCQ">They</a> <a href="http://www.youtube.com/watch?v=EDxOSsiaEYU">allow</a> <a href="http://www.youtube.com/watch?v=FAeu3esj1nM">you</a> <a href="http://www.youtube.com/watch?v=FnxEUBZ-9WY">to</a> <a href="http://www.youtube.com/watch?v=G2r5KVosjIw">become</a> <a href="http://www.youtube.com/watch?v=GnJ1KMY_k_M">a</a> <a href="http://www.youtube.com/watch?v=Gnsjy8lpIH8">compiler</a> <a href="http://www.youtube.com/watch?v=HIymqJtD3fw">developer</a> <a href="http://www.youtube.com/watch?v=llWWXuY52v4">and</a> <a href="http://www.youtube.com/watch?v=Htjh6Vyxkws">extend</a> <a href="http://www.youtube.com/watch?v=Hxxoyc05hWQ">the</a> <a href="http://www.youtube.com/watch?v=6yWl2DX3-gY">language</a> <a href="http://www.youtube.com/watch?v=J9_rfRC49P0">just</a> <a href="http://www.youtube.com/watch?v=JfBzQQ12W5M">that</a> <a href="http://www.youtube.com/watch?v=KCfyNlp7rmw">little</a> <a href="http://www.youtube.com/watch?v=KYwyzTFQ_W4">bit</a> <a href="http://www.youtube.com/watch?v=Ma2Hr0sb5jw">in</a> <a href="http://www.youtube.com/watch?v=KvfmywBHNaI">the</a> <a href="http://www.youtube.com/watch?v=L-I0o5bB0D0">direction</a> <a href="http://www.youtube.com/watch?v=LRnblsA54ZI">you</a> <a href="http://www.youtube.com/watch?v=MQ2sOfXhr3I">need</a> <a href="http://www.youtube.com/watch?v=MX4JXqOCcTs">to</a> <a href="http://www.youtube.com/watch?v=MrTrlRLAH-s">make</a> <a href="http://www.youtube.com/watch?v=Mwf6jxUBU0Q">your</a> <a href="http://www.youtube.com/watch?v=NWD3C0ax-ZY">life</a> <a href="http://www.youtube.com/watch?v=tZYJXI93RCw">easier.</a> <a href="http://www.youtube.com/watch?v=thabOb8WX34">Only</a> <a href="http://www.youtube.com/watch?v=uwhZgR2Wuew">without</a> <a href="http://www.youtube.com/watch?v=v7cpVcnrPu4">the</a> <a href="http://www.youtube.com/watch?v=wyIC3Z0_9J8">pain</a> <a href="http://www.youtube.com/watch?v=x7cMdxp49XQ">and</a> <a href="http://www.youtube.com/watch?v=xpbs6SRQsTI">embarrassment</a> <a href="http://www.youtube.com/watch?v=xqmjmR-vRP0">of</a> <a href="http://www.youtube.com/watch?v=xryLWlBfXa0">pull</a> <a href="http://www.youtube.com/watch?v=yku6QKz6Drc">requests</a> <a href="http://www.youtube.com/watch?v=zWi9Vk77bkY">being</a> <a href="http://www.youtube.com/watch?v=zp5CwgMSOMU">reviewed</a> <a href="http://www.youtube.com/watch?v=O0srg6Lgzgg">and</a> <a href="http://www.youtube.com/watch?v=OOejPz9kV6I">rejected.</a> <a href="http://www.youtube.com/watch?v=PA-mnyNU8VE">And</a> <a href="http://www.youtube.com/watch?v=PMgZ5gia64U">let's</a> <a href="http://www.youtube.com/watch?v=Pxb7KAbADf0">face</a> <a href="http://www.youtube.com/watch?v=QUYILpXU1eQ">it,</a> <a href="http://www.youtube.com/watch?v=QpAimvj3PFs">figuring</a> <a href="http://www.youtube.com/watch?v=QtRKy7uEYks">out</a> <a href="http://www.youtube.com/watch?v=Qwr_aRE-PRw">how</a> <a href="http://www.youtube.com/watch?v=R7pfg5E-JQ4">macros</a> <a href="http://www.youtube.com/watch?v=RCybFtD9ROg">work</a> <a href="http://www.youtube.com/watch?v=Rie4knPIKPw">and</a> <a href="http://www.youtube.com/watch?v=RjwjFmfLfps">how</a> <a href="http://www.youtube.com/watch?v=SQq8lPtK65g">to</a> <a href="http://www.youtube.com/watch?v=dQw4w9WgXcQ">write</a> <a href="http://www.youtube.com/watch?v=-Pk5Mgby5MM">them</a> <a href="http://www.youtube.com/watch?v=L_yV2-bWXwI">is</a> <a href="http://www.youtube.com/watch?v=n_hGvuawYu0">in</a> <a href="http://www.youtube.com/watch?v=atKdIJclUfc">itself</a> <a href="http://www.youtube.com/watch?v=RYCuH5aargc">a</a> <a href="http://www.youtube.com/watch?v=SnmUALfrJMw">fun</a> <a href="http://www.youtube.com/watch?v=TUrxPOF9kZs">exercise.</a></p>
<p><a href="http://www.youtube.com/watch?v=weqhr9PaSG0">I'd</a> <a href="http://www.youtube.com/watch?v=VDJRMjtzvlg">also</a> <a href="http://www.youtube.com/watch?v=P_eywF1ATFQ">like</a> <a href="http://www.youtube.com/watch?v=Vdd-z87h0Ek">to</a> <a href="http://www.youtube.com/watch?v=WyN7uzv55Qs">thank</a> <a href="http://www.youtube.com/watch?v=XSxbmpBMz0E">the</a> <a href="http://www.youtube.com/watch?v=XfXZcXOCKNg">wonderful</a> <a href="http://www.youtube.com/watch?v=Xl_2aOOpTmg">Ace</a> <a href="http://www.youtube.com/watch?v=Y4l0vyLEQ8g">of</a> <a href="http://www.youtube.com/watch?v=Y6JVsIiMLyU">Angels</a> <a href="http://www.youtube.com/watch?v=YLnZWkMUKRA">for</a> <a href="http://www.youtube.com/watch?v=YsxKBvJFtuU">their</a> <a href="http://www.youtube.com/watch?v=YvnlMaYUe24">performances</a> <a href="http://www.youtube.com/watch?v=ZiRcTCfAjdM">and</a> <a href="http://www.youtube.com/watch?v=ZpgTevBUStE">the</a> <a href="http://www.youtube.com/watch?v=_2oVTghzm5I">dozens</a> <a href="http://www.youtube.com/watch?v=_39a5TJC47E">of</a> <a href="http://www.youtube.com/watch?v=SUibrPIhQvY">Korean</a> <a href="http://www.youtube.com/watch?v=_HizAsI9KnM">camera</a> <a href="http://www.youtube.com/watch?v=_R1W21n5f74">men</a> <a href="http://www.youtube.com/watch?v=_sBtnpRE4r0">offering</a> <a href="http://www.youtube.com/watch?v=_xSixaY-KKE">high</a> <a href="http://www.youtube.com/watch?v=afgWZGd-3gg">quality</a> <a href="http://www.youtube.com/watch?v=arx-pq-7Z1o">captures</a> <a href="http://www.youtube.com/watch?v=bQ3XlIQyPEI">of</a> <a href="http://www.youtube.com/watch?v=biCkA4q2_FE">them.</a> <a href="http://www.youtube.com/watch?v=chkdylyKgJE">They</a> <a href="http://www.youtube.com/watch?v=dC2iOh831Jg">were</a> <a href="http://www.youtube.com/watch?v=dCDij8E7fwo">crucial</a> <a href="http://www.youtube.com/watch?v=dLTSeAiPK34">to</a> <a href="http://www.youtube.com/watch?v=JsQjs-mQ-Ko">overcome</a> <a href="http://www.youtube.com/watch?v=eK3KJ7AlxNs">the</a> <a href="http://www.youtube.com/watch?v=ePuj3g2giUY">hurdles</a> <a href="http://www.youtube.com/watch?v=f0uY0zFG0y8">mentioned</a> <a href="http://www.youtube.com/watch?v=fLZG31_AKsQ">above.</a> <a href="http://www.youtube.com/watch?v=fZ8ebCBb8z4">At</a> <a href="http://www.youtube.com/watch?v=haOvfeui2K0">times</a> <a href="http://www.youtube.com/watch?v=i0jDsG94m90">of</a> <a href="http://www.youtube.com/watch?v=iAertuXKvnc">difficulty,</a> <a href="http://www.youtube.com/watch?v=iG7sb6PlbeQ">clearing</a> <a href="http://www.youtube.com/watch?v=k8K7SDf54LY">your</a> <a href="http://www.youtube.com/watch?v=lBbC5L2p5gM">mind</a> <a href="http://www.youtube.com/watch?v=l_eNMOFXcM8">of</a> <a href="http://www.youtube.com/watch?v=ljwkRDdhjVM">thoughts</a> <a href="http://www.youtube.com/watch?v=lrzPvetaDUY">by</a> <a href="http://www.youtube.com/watch?v=mCFIWB_gIBQ">looking</a> <a href="http://www.youtube.com/watch?v=mG_UY_SCKqg">at</a> <a href="http://www.youtube.com/watch?v=mSinameBSN0">something</a> <a href="http://www.youtube.com/watch?v=n3cZIdMd5QM">else</a> <a href="http://www.youtube.com/watch?v=nflUbvqSgMU">can</a> <a href="http://www.youtube.com/watch?v=nkHPrIJtAD8">help.</a> <a href="http://www.youtube.com/watch?v=o2Rx2TeErho">More</a> <a href="http://www.youtube.com/watch?v=o4Wa7nwB29M">so</a> <a href="http://www.youtube.com/watch?v=oG48HRGe5LA">if</a> <a href="http://www.youtube.com/watch?v=ojvES51dOUY">what</a> <a href="http://www.youtube.com/watch?v=ooJiMFG-Uuo">you</a> <a href="http://www.youtube.com/watch?v=otJ8jzIBtMM">are</a> <a href="http://www.youtube.com/watch?v=ozDnGDxh7ZA">looking</a> <a href="http://www.youtube.com/watch?v=vvpMLSFxnOs">at</a> <a href="http://www.youtube.com/watch?v=qeOycPTKbl0">inspires</a> <a href="http://www.youtube.com/watch?v=qgen0Hv4rBk">you</a> <a href="http://www.youtube.com/watch?v=r-4_j1V6frE">to</a> <a href="http://www.youtube.com/watch?v=r4jFOB0cu6s">keep</a> <a href="http://www.youtube.com/watch?v=s1StWjh0oFo">working.</a> <a href="http://www.youtube.com/watch?v=sQdoijEyc3g">Ace</a> <a href="http://www.youtube.com/watch?v=sbG87-GbQWM">of</a> <a href="http://www.youtube.com/watch?v=stBjpAXjRpY">Angels,</a> <a href="http://www.youtube.com/watch?v=t4b2Zb67_Ro">fighting!</a></p>
<pre class='literal'>$ nim c -r miniskirt
miniskirt.nim(3, 0) Info: instantiation from here
???(???, ???) Error: 4k youtube video expected</pre>
	</div>
		<hr>
		<p>See <a href="../../../index.html">the article index</a> or browse
		articles by tags:     <a href="../../../tags/nim.html">nim</a>
    ,
    <a href="../../../tags/programming.html">programming</a>
    ,
    <a href="../../../tags/languages.html">languages</a>
    ,
    <a href="../../../tags/objc.html">objc</a>
    ,
    <a href="../../../tags/metaprogramming.html">metaprogramming</a>
    
.<br>Published on: 12/10/2014 21:46. Last update:
			16/08/2020 12:45. <a
			href="../../../feed.xml"><img
			alt="rss feed" src="../../../i/Feed-icon.svg"
			width="18pt" height="18pt"></a><br>
		Copyright 2021 by <a href="../../../about.html">Grzegorz Adam Hankiewicz</a>.<br>
		Generated with <a href="https://github.com/dom96/ipsumgenera">ipsum
			genera</a>. Look at <a
		href="https://github.com/gradha/gradha.github.io">the
		source code</a>.</p>
	</body>
</html>

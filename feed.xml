<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Rants from the Ballmer Peak</title>
  <link href="http://gradha.github.io/" />
  <link href="http://gradha.github.io/feed.xml" rel="self" />
  <id>http://gradha.github.io/</id>
  <generator>ipsumgenera</generator>
  <updated>2014-10-12T21:55:55Z</updated>
    <entry>
      <title>Adding Objective-C properties to Nimrod objects with macros</title>
      <link rel="alternate" type="text/html" href="http://gradha.github.io/articles/2014/10/adding-objectivec-properties-to-nimrod-objects-with-macros.html"/>
      <id>http://gradha.github.io/articles/2014/10/adding-objectivec-properties-to-nimrod-objects-with-macros.html</id>
      <published>2014-10-12T21:46:00Z</published>
      <updated>2014-10-12T22:55:00Z</updated>
      <author><name>Grzegorz Adam Hankiewicz</name></author>
      <content type="html">
        &lt;h1&gt;Adding Objective-C properties to Nimrod objects with macros&lt;/h1&gt;&lt;p&gt;The &lt;a href=&quot;http://nimrod-lang.org&quot;&gt;Nimrod programming language&lt;/a&gt; allows one to use &lt;a href=&quot;http://nimrod-lang.org/manual.html#macros&quot;&gt;macros&lt;/a&gt; to extend the language. In a &lt;a href=&quot;http://gradha.github.io/articles/2014/10/../06/dirrty-objects-in-dirrty-nimrod.html&quot;&gt;previous article&lt;/a&gt; we were guided by &lt;a href=&quot;https://en.wikipedia.org/wiki/Christina_Aguilera&quot;&gt;Christina Aguilera&lt;/a&gt; into adding Objective-C like object properties to the Nimrod programming language. However, the result, while effective, looked quite spartan and low class, like &lt;a href=&quot;https://en.wikipedia.org/wiki/File:Dirrty_Slutdrop.jpg&quot;&gt;Christina's slutdrop&lt;/a&gt;. Here is the code I ended up with:&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;utils&lt;/span&gt;

&lt;span class=&quot;Keyword&quot;&gt;type&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;object&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;Dirrty&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;Fname&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;Fsurname&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;Fage&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;int&lt;/span&gt;

&lt;span class=&quot;Identifier&quot;&gt;generateProperties&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;Identifier&quot;&gt;generateProperties&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;surname&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;Identifier&quot;&gt;generateProperties&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;age&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;Keyword&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;## Exercise the setters and getters.&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Christina&amp;quot;&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Is &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot; dirrty? &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirrty&lt;/span&gt;

&lt;span class=&quot;Keyword&quot;&gt;when&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;isMainModule&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;This code has several issues on the long run:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;The &lt;code&gt;type&lt;/code&gt; definition is separate from the &lt;code&gt;generateProperties()&lt;/code&gt; calls. This means it is easy to &lt;span style=&quot;font-style: italic;&quot;&gt;lose sync&lt;/span&gt; between both.&lt;/li&gt;&lt;li&gt;There is much repeating of simple identifiers. Worse, because the type and the property generating macro is separate, the type definition has to use the &lt;span style=&quot;font-style: italic;&quot;&gt;implied&lt;/span&gt; &lt;code&gt;F&lt;/code&gt; prefix for instance variables being used as properties, and the non-F version for the property (or vice versa, should you write your macro the other way round). It is easy to get distracted and mess up one or the other and later get shocked by the compiler.&lt;/li&gt;&lt;li&gt;Just like with the identifiers, the type for each field is repeated too. This is just nonsense. It is all you can do with C like macros though, so to the experienced C/C++ programmer it may not look &lt;span style=&quot;font-style: italic;&quot;&gt;that horrible&lt;/span&gt;.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;With Nimrod you can do better. And better than the obviousness of Christina's slutdrop, I find &lt;a href=&quot;https://en.wikipedia.org/wiki/AOA_(band)&quot;&gt;Ace of Angels'&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=q6f-LLM1H6U&quot;&gt;miniskirt unzipping and ass shaking&lt;/a&gt; more tasteful and pleasant to the eye (after all, at the moment I'm writing this Christina loses with 9.986.070 views to the 11.394.880 views of Ace of Angels, yet AOA's video has existed for far less time). Following the steps of these Queens Of Teasing, here is a quick peek at how the code will end up after we drive ourselves crazy with some serious macro writing:&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;utils&lt;/span&gt;

&lt;span class=&quot;Identifier&quot;&gt;makeDirtyWithStyle&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;type&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;object&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;Dirrty&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;dirty&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;surname&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;clean&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;age&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;int&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;internalValue&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;float&lt;/span&gt;

&lt;span class=&quot;Keyword&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Christina&amp;quot;&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Is &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot; dirrty? &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirrty&lt;/span&gt;

&lt;span class=&quot;Keyword&quot;&gt;when&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;isMainModule&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/p&gt;
&lt;h1&gt;The roadmap ahead&lt;/h1&gt;&lt;p&gt;We can see by the previous teaser that we got rid of the &lt;code&gt;generateProperties()&lt;/code&gt; macro completely. Yay! That code has been moved into the &lt;code&gt;makeDirtyWithStyle()&lt;/code&gt; macro. Instead of a call, what we are doing here is &lt;a href=&quot;http://nimrod-lang.org/tut2.html#statement-macros&quot;&gt;invoking our macro as a statement&lt;/a&gt;. Everything indented after the colon will be passed in to the macro as its last parameter.  How? As an &lt;a href=&quot;https://en.wikipedia.org/wiki/Abstract_syntax_tree&quot;&gt;abstract syntax tree&lt;/a&gt; or AST for short.&lt;/p&gt;

&lt;center&gt;&lt;a href=&quot;http://knowyourmeme.com/memes/x-x-everywhere&quot;&gt;&lt;img
    src=&quot;../../../i/asts-asts-everywhere.jpg&quot;
    alt=&quot;If you close your eyes hard you can sometimes see the ASTs&quot;
    style=&quot;width:100%;max-width:600px&quot;
    hspace=&quot;8pt&quot; vspace=&quot;8pt&quot;&gt;&lt;/a&gt;&lt;/center&gt;&lt;br&gt;&lt;p&gt;Our new version of the macro will still use the same &lt;a href=&quot;http://nimrod-lang.org/macros.html#quote&quot;&gt;quasi-quoting&lt;/a&gt; to generate the setter and getter procs. However, before generating any code the macro will be able to traverse the input AST and figure out itself what fields of the object are meant to be used for the setter and getter. On top of that, it will automatically mangle the fields to use the &lt;code&gt;F&lt;/code&gt; prefix letter (similar to Objective-C prefixing properties with an underscore in case you need to access them directly), and we will simulate our own mini DSL through identifiers to fake language support to specify which property setters need to mark the object's dirty flag as dirty or not. You can see that in the example code through the words &lt;code&gt;dirty&lt;/code&gt; and &lt;code&gt;clean&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;a href=&quot;http://nimrod-lang.org/tut1.html&quot;&gt;Nimrod Tutorial&lt;/a&gt; has a &lt;a href=&quot;http://nimrod-lang.org/tut2.html#building-your-first-macro&quot;&gt;Building your first macro&lt;/a&gt; section. You are meant to have at least skimmed through that because I won't be explaining all the basics, only the ones I'm interested in. Also, much of the typical error handling code you find in macros won't be present for brevity. What error handling code would be this? In the previous &lt;code&gt;generateProperties&lt;/code&gt; version the user of this macro can pass only three very specific parameters, but in the statement version you can now pass any random Nimrod code to our macro, and it has to figure out how to treat it.  If the user makes any mistakes in the construct, rather than simply quitting or aborting a helpful error message should be provided. That makes the code a lot more verbose checking for all possible inputs (and you are sort of becoming a Nimrod compiler developer at the same time!).&lt;/p&gt;
&lt;p&gt;Don't get scared now of the length of this blog post, it is all due to the example code lines being repeated several times to make the text more contextual. In any case I recommend you to either download the source code (&lt;a href=&quot;http://gradha.github.io/articles/2014/10/../../../code/18/utils.nim&quot;&gt;utils.nim&lt;/a&gt; and &lt;a href=&quot;http://gradha.github.io/articles/2014/10/../../../code/18/miniskirt.nim&quot;&gt;miniskirt.nim&lt;/a&gt;) or view them through GitHub, which I will use to quickly point to the appropriate lines (see &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim&quot;&gt;utils.nim&lt;/a&gt; and &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/miniskirt.nim&quot;&gt;miniskirt.nim&lt;/a&gt; on GitHub). The truth is that most of the macro is pretty simple, it has already been explained and what is left as an exercise for the writer is to transform words into code.&lt;/p&gt;
&lt;p&gt;While the original and destination source code files help to get an idea of what the user will end up writing, the compiler only cares about ASTs. Just like the &lt;a href=&quot;http://nimrod-lang.org/tut2.html#building-your-first-macro&quot;&gt;Building your first macro&lt;/a&gt; tutorial recommends, we can use the &lt;a href=&quot;http://nimrod-lang.org/macros.html#dumpTree&quot;&gt;dumpTree() macro&lt;/a&gt; to dump the input AST and see what the compiler is processing. For convenience, here you have the result &lt;a href=&quot;http://nimrod-lang.org/macros.html#dumpTree&quot;&gt;dumpTree()&lt;/a&gt; along the final result of &lt;a href=&quot;http://nimrod-lang.org/macros.html#treeRepr&quot;&gt;treeRepr()&lt;/a&gt; called inside the macro to show how the final AST will look &lt;span style=&quot;font-weight: bold;&quot;&gt;after&lt;/span&gt; to the compiler. The input AST is on the left, the final AST is on the right. Additional unicode numbered markers have been placed to point out the interesting parts:&lt;pre class='literal'&gt;
type
  Person = object of Dirrty
    dirty ①, name* ②, surname* ②: string
    clean ①, age* ②: int
    internalValue ③: float
----
StmtList                   StmtList
  TypeSection                TypeSection
    TypeDef                    TypeDef
      Ident !&amp;quot;Person&amp;quot;            Ident !&amp;quot;Person&amp;quot;
      Empty                      Empty
      ObjectTy                   ObjectTy
        Empty                      Empty
        OfInherit                  OfInherit
          Ident !&amp;quot;Dirrty&amp;quot;            Ident !&amp;quot;Dirrty&amp;quot;
        RecList                    RecList
          IdentDefs                  IdentDefs
            Ident !&amp;quot;dirty&amp;quot;             ①
            Postfix                    Postfix
              Ident !&amp;quot;*&amp;quot;                 Ident !&amp;quot;*&amp;quot;
              Ident !&amp;quot;name&amp;quot;              Ident !&amp;quot;Fname&amp;quot; ②
            Postfix                    Postfix
              Ident !&amp;quot;*&amp;quot;                 Ident !&amp;quot;*&amp;quot;
              Ident !&amp;quot;surname&amp;quot;           Ident !&amp;quot;Fsurname&amp;quot; ②
            Ident !&amp;quot;string&amp;quot;            Ident !&amp;quot;string&amp;quot;
            Empty                      Empty
          IdentDefs                  IdentDefs
            Ident !&amp;quot;clean&amp;quot;             ①
            Postfix                    Postfix
              Ident !&amp;quot;*&amp;quot;                 Ident !&amp;quot;*&amp;quot;
              Ident !&amp;quot;age&amp;quot;               Ident !&amp;quot;Fage&amp;quot; ②
            Ident !&amp;quot;int&amp;quot;               Ident !&amp;quot;int&amp;quot;
            Empty                      Empty
          IdentDefs                  IdentDefs ③
            Ident !&amp;quot;internalValue&amp;quot;     Ident !&amp;quot;internalValue&amp;quot;
            Ident !&amp;quot;float&amp;quot;             Ident !&amp;quot;float&amp;quot;
            Empty                      Empty&lt;/pre&gt;&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;The &lt;code&gt;dirty&lt;/code&gt; and &lt;code&gt;clean&lt;/code&gt; identifiers are removed from the right AST. They are not used by the compiler, they are markers our macro uses to modify the behaviour of the proc generating code.&lt;/li&gt;&lt;li&gt;The fields marked as properties will be mangled in the final tree to contain the prefix &lt;code&gt;F&lt;/code&gt; letter. Note how all the identifiers on each line get mangled, we have to control this too. And remember that the last identifier is the type which we should not touch!&lt;/li&gt;&lt;li&gt;In this example, any list of identifiers starting with the identifier &lt;code&gt;dirty&lt;/code&gt; or &lt;code&gt;clean&lt;/code&gt;  will be mangled into a property. The &lt;code&gt;internalValue&lt;/code&gt; is there precisely to test that we don't generate a property for it. As you can see it is identical to the left AST.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;For the purpose of making our macro traversing code more resilient (and fun!) this version of the example includes the &lt;code&gt;*&lt;/code&gt; postfix operator, which is used in Nimrod to &lt;span style=&quot;font-style: italic;&quot;&gt;export&lt;/span&gt; symbols out of the module's scope. Not required for the small example to work, it is something very common our macro would find in the real world. Our version will deal with it correctly when traversing the AST but we won't be using it to change the visibility of the procs generated for each property for brevity (it's quite easy to add but increases the verbosity of the example, and its already quite long as it is).&lt;/p&gt;
&lt;p&gt;What is missing in this AST is that the right version will be followed with a lot of proc definitions which are generated to emulate the Objective-C like properties. This would be the output from our previous &lt;code&gt;generateProperties()&lt;/code&gt; macro but is not particularly interesting in itself and only adds line noise so it has not been included in this AST representation.&lt;/p&gt;
&lt;h1&gt;Row, row, row your AST…&lt;/h1&gt;&lt;p&gt;Let's start then with the &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L115&quot;&gt;makeDirtyWithStyle()&lt;/a&gt; macro:&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Keyword&quot;&gt;macro&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;makeDirtyWithStyle&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;stmt&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;stmt&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;immediate&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;foundObjects&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;initTable&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;seq&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;procTuple&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;# Find and mangle&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;children&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;kind&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;nnkTypeSection&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;continue&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;children&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;Keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;kind&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;nnkTypeDef&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;continue&lt;/span&gt;
      &lt;span class=&quot;Keyword&quot;&gt;let&lt;/span&gt;
        &lt;span class=&quot;Identifier&quot;&gt;typeName&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;Identifier&quot;&gt;typeNode&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;Keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;typeNode&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;kind&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;nnkObjectTy&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;continue&lt;/span&gt;
      &lt;span class=&quot;Keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;mangledObject&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;rewriteObject&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;mangledObject&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;node&lt;/span&gt;
      &lt;span class=&quot;Comment&quot;&gt;# Store the found symbols for a second proc phase.&lt;/span&gt;
      &lt;span class=&quot;Keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;mangledObject&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;found&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;len&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;Identifier&quot;&gt;foundObjects&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;typeName&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;mangledObject&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;found&lt;/span&gt;
  
  &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;body&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;# Iterate through fields and generate property procs.&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;objectName&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;mangledSymbols&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;foundObjects&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;pairs&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;dirty&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;typ&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;mangledSymbols&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;items&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;generateProperties&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirty&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;Identifier&quot;&gt;objectName&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;typ&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;The macro has two clear parts: iterating through the AST looking for &lt;code&gt;foundObjects&lt;/code&gt;, and then looping over the found results to call the &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L84&quot;&gt;generateProperties()&lt;/a&gt; helper. During the search we also modify the &lt;code&gt;body&lt;/code&gt; to remove some identifiers and prefix others with the letter &lt;code&gt;F&lt;/code&gt;. This is fine with the compiler. If the macro doesn't find any object to mangle, the &lt;code&gt;result = body&lt;/code&gt; line will essentially pass the user input raw to the compiler, plus the following loop won't do anything. The &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L84&quot;&gt;generateProperties()&lt;/a&gt; helper is nearly intact from the previous article, the only modification has been to add the &lt;code&gt;dirty&lt;/code&gt; parameter. With this parameter we specify if we want the generated setter to set the &lt;code&gt;dirrty&lt;/code&gt; field to &lt;code&gt;true&lt;/code&gt;, which allows us to generate setters which don't modify the &lt;code&gt;dirrty&lt;/code&gt; state of the object.&lt;/p&gt;
&lt;p&gt;Traversing the AST is quite easy, first we check that we are inside a &lt;code&gt;nnkTypeSection&lt;/code&gt;. Inside this node, we continue to go deeper until we find a &lt;code&gt;nnkTypeDef&lt;/code&gt; node, which is what we wanted in first place. The user could be defining types &lt;span style=&quot;font-weight: bold;&quot;&gt;other&lt;/span&gt; than objects. For instance, they could be defining a &lt;code&gt;tuple&lt;/code&gt; along their object. So we are only interested in &lt;code&gt;nnkObjectTy&lt;/code&gt; nodes. Finally, we call the &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L51&quot;&gt;rewriteObject()&lt;/a&gt; helper proc which returns the mangled AST node plus a sequence of &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L14&quot;&gt;procTuple&lt;/a&gt; elements which contain what fields need to be mangled. Maybe the object had none, so we check for the length of the &lt;code&gt;mangledObject.found&lt;/code&gt; list before doing anything. Still, we can happily replace the AST node with the returned value (&lt;code&gt;n[2] = mangledObject.node&lt;/code&gt;) because it won't have changed at all.&lt;/p&gt;
&lt;p&gt;So what does the &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L51&quot;&gt;rewriteObject()&lt;/a&gt; helper do?&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Keyword&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;rewriteObject&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;parentNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;PNimrodNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;rewriteTuple&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;# Create a copy which we will modify and return.&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;node&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;copyNimTree&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;parentNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;found&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
  
  &lt;span class=&quot;Comment&quot;&gt;# Ignore the object unless it inherits from Dirrty.&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;inheritanceNode&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;parentNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;inheritanceNode&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;kind&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;nnkOfInherit&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;return&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;inheritanceNode&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;expectMinLen&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;inheritanceNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Dirrty&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;return&lt;/span&gt;
  
  &lt;span class=&quot;Comment&quot;&gt;# Get the list of records for the object.&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;recList&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;recList&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;kind&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;nnkRecList&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;error&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Was expecting a record list&amp;quot;&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;nodeIndex&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;recList&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;idList&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;recList&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;nodeIndex&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;Comment&quot;&gt;# Only mutate those which start with fake keywords.&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;firstRawName&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;basename&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;idList&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;firstRawName&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;StringLit&quot;&gt;&amp;quot;clean&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;dirty&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;Keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;found&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;procTuple&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;found&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirty&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;firstRawName&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;dirty&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;del&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;idList&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;Comment&quot;&gt;# Removes the first identifier.&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;found&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;typ&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;idList&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;idlist&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;len&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;Comment&quot;&gt;# Get the identifiers.&lt;/span&gt;
      &lt;span class=&quot;Keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;identifier&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;idList&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;stripTypeIdentifier&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;Identifier&quot;&gt;found&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;identifier&lt;/span&gt;
        &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;found&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;found&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;Comment&quot;&gt;# Mangle the remaining identifiers&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;idList&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;prefixIdentifiersWithF&lt;/span&gt;
&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;The first line which calls &lt;a href=&quot;http://nimrod-lang.org/macros.html#copyNimTree&quot;&gt;copyNimTree()&lt;/a&gt; is not strictly needed, but can be useful in case we would need to do multiple passes on the AST and have to compare our working version with the original one. Then we make sure the object type definition we are dealing with actually inherits from our custom &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L11&quot;&gt;Dirrty&lt;/a&gt; object. This means we won't get automatic properties on objects which inherit from other classes. Alternatively, we could detect this case and prevent the generated setter from attempting to modify the field &lt;code&gt;dirrty&lt;/code&gt; which won't be present. I've decided to only add properties to dirrty objects for clarity (otherwise it's just a matter of more &lt;code&gt;ifs&lt;/code&gt; in the following lines).&lt;/p&gt;
&lt;p&gt;When we deal with the identifier record list what we do is detect if the first identifier is &lt;code&gt;clean&lt;/code&gt; or &lt;code&gt;dirty&lt;/code&gt;. These are our &lt;span style=&quot;font-style: italic;&quot;&gt;fake&lt;/span&gt; DSL keywords which tell the macro that the remaining fields need to be mangled. If the found keyword is &lt;code&gt;dirty&lt;/code&gt;, the generated setter will modify the &lt;code&gt;dirrty&lt;/code&gt; field, but otherwise the rest of the code is quite similar. In any case we remove the first fake identifier, then we loop over the remaining identifiers modifying our &lt;code&gt;var found: procTuple&lt;/code&gt; with the name and adding a copy to the &lt;code&gt;result.found&lt;/code&gt; sequence. For this loop the &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L21&quot;&gt;stripTypeIdentifier()&lt;/a&gt; helper is used which simply iterates through the list of identifiers (except the last one, which is the type definition!) and returns them as strings:&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Keyword&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;stripTypeIdentifier&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;identDefsNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;PNimrodNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;seq&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;# Returns the names minus the type from an identifier list.&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;identDefsNode&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;expectMinLen&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;last&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;identDefsNode&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;len&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;identDefsNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;last&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;expectKind&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;nnkEmpty&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;identDefsNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;last&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;expectKind&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;nnkIdent&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
  
  &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;last&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;identDefsNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;basename&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;Once the identifiers without mangling have been added to the list of found fields we pass control to the &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L44&quot;&gt;prefixIdentifiersWithF()&lt;/a&gt; helper proc to actually mangle them with the &lt;code&gt;F&lt;/code&gt; prefix:&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Keyword&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;prefixNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;PNimrodNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;PNimrodNode&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;# Returns the ident node with a prefix F.&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;kind&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;nnkIdent&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;ident&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;StringLit&quot;&gt;&amp;quot;F&amp;quot;&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;nnkPostfix&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;copyNimTree&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;basename&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;F&amp;quot;&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;basename&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;error&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Don't know how to prefix &amp;quot;&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;treeRepr&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;Keyword&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;prefixIdentifiersWithF&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;identDefsNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;PNimrodNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;# Replace all nodes except last with F version.&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;last&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;identDefsNode&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;len&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;last&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;identDefsNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;identDefsNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;prefixNode&lt;/span&gt;
&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;As you can see &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L44&quot;&gt;prefixIdentifiersWithF()&lt;/a&gt; is pretty similar to &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L21&quot;&gt;stripTypeIdentifier()&lt;/a&gt;, but instead of adding the identifier to a result list it calls the &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L34&quot;&gt;prefixNode()&lt;/a&gt; helper which mangles the node identifier. Here you can see us dealing with &lt;code&gt;nnkPostfix&lt;/code&gt; nodes, which are fields marked with &lt;code&gt;*&lt;/code&gt;. Again, as mentioned above, we could detect which of the fields are marked with &lt;code&gt;*&lt;/code&gt; to propagate the appropriate symbol visibility to the generated property procs.  This is left as an exercise to the reader (hint: add a visibility field to &lt;code&gt;procTuple&lt;/code&gt; which already contains other field info).&lt;/p&gt;
&lt;p&gt;For completeness, the snippets of code shown so far use two types which haven't been defined, &lt;code&gt;rewriteTuple&lt;/code&gt; and &lt;code&gt;procTuple&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Keyword&quot;&gt;type&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;procTuple&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirty&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;typ&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
  
  &lt;span class=&quot;Identifier&quot;&gt;rewriteTuple&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;PNimrodNode&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;found&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;seq&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;procTuple&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;Nothing too fancy, they are just the internal structures used to group and communicate results between the procs. And… that's all folks! To verify everything is working as expected, here is an &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/miniskirt.nim#L15&quot;&gt;extended version of our original property usage test case&lt;/a&gt;:&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Keyword&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;extraTest&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Doing now extra test&amp;quot;&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Christina&amp;quot;&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Is &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot; dirrty? &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirrty&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirrty&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;age&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;18&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Is &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot; with &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;age&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot; years dirrty? &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirrty&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;internalValue&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;FloatNumber&quot;&gt;3.14&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;And after changing the internal value? &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirrty&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;# --&amp;gt; Doing now extra test&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;#     Is Christina dirrty? true&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;#     Is Christina with 18 years dirrty? false&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;#     And after changing the internal value? false&lt;/span&gt;
&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;In this version of the test we repeat the original dirtying of the &lt;code&gt;Person&lt;/code&gt; object through the generated &lt;code&gt;name=()&lt;/code&gt; setter, which modifies the &lt;code&gt;dirrty&lt;/code&gt; field. Then, we reset the &lt;code&gt;dirrty&lt;/code&gt;  field and modify the age. The modification of the &lt;code&gt;age&lt;/code&gt; property uses also a setter, but since this one was marked as &lt;code&gt;clean&lt;/code&gt; the &lt;code&gt;dirrty&lt;/code&gt; field won't change its value. Finally, we modify the &lt;code&gt;internalValue&lt;/code&gt;. This value was not marked with our fake keywords, so the macro won't be generating any setter or getter. How can we verify this? We could modify our macro to dump the final AST after the generated procs are added. We can also inspect our &lt;code&gt;nimcache&lt;/code&gt; folder which &lt;a href=&quot;http://build.nimrod-lang.org/docs/backends.html#nimcache-naming-logic&quot;&gt;should contain the generated C files&lt;/a&gt;. In my case this is part of the generated code for the &lt;code&gt;extraTest()&lt;/code&gt; proc:&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;.&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;nimln&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;22&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;miniskirt.nim&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;nimln&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;22&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;miniskirt.nim&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;LOC4&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;LOC4&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;age_111032&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;LOC5&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;LOC5&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;nimIntToStr&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;LOC4&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;nimln&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;22&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;miniskirt.nim&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;LOC6&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;LOC6&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;nimBoolToStr&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;Sup&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;Dirrty&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;StringLit&quot;&gt;&amp;quot;%s%s%s%s%s%s&lt;/span&gt;&lt;span class=&quot;EscapeSequence&quot;&gt;\012&lt;/span&gt;&lt;span class=&quot;StringLit&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;NimStringDesc&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;TMP230&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;LOC3&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;NimStringDesc&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;TMP233&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;LOC5&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;NimStringDesc&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;TMP234&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;LOC6&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;nimln&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;miniskirt.nim&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;Internalvalue&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;FloatNumber&quot;&gt;3.1400000000000001e+00&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;nimln&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;miniskirt.nim&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;nimln&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;DecNumber&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;miniskirt.nim&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;LOC7&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;DecNumber&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;LOC7&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;nimBoolToStr&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;Sup&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;Dirrty&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;StringLit&quot;&gt;&amp;quot;%s%s&lt;/span&gt;&lt;span class=&quot;EscapeSequence&quot;&gt;\012&lt;/span&gt;&lt;span class=&quot;StringLit&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;NimStringDesc&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;TMP235&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;LOC7&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;popFrame&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;Punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;.&lt;/span&gt;
&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;While there is much low level and debug keeping stuff, note how the modification of the age invokes the &lt;code&gt;LOC4 = age_111032(&amp;amp;a);&lt;/code&gt; function call (our custom generated setter), while the modification of the &lt;code&gt;internalValue&lt;/code&gt; doesn't do any call, simply assigns with &lt;code&gt;a.Internalvalue = 3.1400000000000001e+00;&lt;/code&gt;. That means we have successfully created a property generation macro, with cool fake pseudo keywords, and it works exactly were we want it to work! That's a great deal better than simple C preprocessor macros.&lt;/p&gt;
&lt;h1&gt;Looking under the rug&lt;/h1&gt;&lt;p&gt;While we have accomplished what we wanted (cooler Objective-C property like generation code in Nimrod), there are still some rough edges we can't deal with, or annoying stuff which hopefully will be improved in future versions of Nimrod. From our user perspective, to the left you can see the code we now can write. To the right you can see what could be written if the language provided native property support (which is impossible, or do you know of any language providing built-in object dirty field tracking?):&lt;pre class='literal'&gt;
makeDirtyWithStyle:                  dirtyType:
  type                                 Person = object of Dirrty
    Person = object of Dirrty            dirtyProperties:
      dirty, name*, surname*: string         name*, surname*: string
      clean, age*: int                   cleanProperties:
      internalValue: float                   age*: int
                                         privateFields:
                                             internalValue: float&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;If we had our way and our hypothetical language would implement this feature directly, we could mark our objects directly with &lt;code&gt;dirtyProperties&lt;/code&gt;, &lt;code&gt;cleanProperties&lt;/code&gt; and &lt;code&gt;privateFields&lt;/code&gt; sections. These would be recognised as keywords by IDEs and editors. We have to settle for fake identifiers. It's not bad, but could be worse. What is more annoying is that we can't get rid of the explicit &lt;code&gt;type&lt;/code&gt; keyword. Why? Because the Nimrod compiler still has to parse that code into &lt;span style=&quot;font-weight: bold;&quot;&gt;VALID AST&lt;/span&gt; before it can pass it to our macro. And it is the &lt;code&gt;type&lt;/code&gt; keyword which tells the parser that what follows should be treated as a &lt;code&gt;TypeSection&lt;/code&gt; with &lt;code&gt;TypeDef&lt;/code&gt; and other stuff instead of say, a &lt;code&gt;proc&lt;/code&gt; definition. Here you can hear lisp programmers laughing at our puny syntax limitations. Still, Nimrod achieves the power of true macros with little limitations. Would it be possible for Nimrod (or just any other language) to allow user code extend the compiler parser with custom DSL rules? I think that would be neat. And madness. Madness is neat, I'm still patiently waiting for macros which modify the AST of the caller to the shock and horror of anybody reading my code…&lt;/p&gt;
&lt;p&gt;Possibly the most frustrating issue with writing Nimrod macros now is the lack of proper documentation. While there is that &lt;a href=&quot;http://nimrod-lang.org/tut2.html#building-your-first-macro&quot;&gt;introductory tutorial&lt;/a&gt;, the &lt;a href=&quot;http://nimrod-lang.org/macros.html&quot;&gt;macros module API&lt;/a&gt; seems to have more sections filled with &lt;code&gt;To be written&lt;/code&gt; than actual text, and many of the actual descriptions are rather useless to newcomers (don't tell me &lt;a href=&quot;http://nimrod-lang.org/macros.html#newEmptyNode&quot;&gt;newEmptyNode()&lt;/a&gt; creates an empty node, tell me in what situations I would like that, or how do I use the result with other procs!). It's not a surprise that one of the past enhancements to the documentation generator was to add the &lt;code&gt;See source&lt;/code&gt; link, it's nearly the only crutch you have to figure out how to do stuff (and that's if you figure out what each proc does).&lt;/p&gt;
&lt;p&gt;One more annoying issue is the lack of helpful stack traces during AST error handling, which can happen a lot when developing macros. When you are writing normal code, you get runtime stack traces which show where the execution of the program was and hopefully by going to the mentioned lines you can fix something to keep going. I present you the most useless stack trace &lt;span style=&quot;font-weight: bold;&quot;&gt;from hell&lt;/span&gt;:&lt;pre class='literal'&gt;
miniskirt.nim(3, 0) Info: instantiation from here
???(???, ???) Error: type expected&lt;/pre&gt;&lt;/p&gt;

&lt;center&gt;&lt;a href=&quot;http://www.idol-grapher.com/1239&quot;&gt;&lt;img
    src=&quot;../../../i/error-type-expected.jpg&quot;
    alt=&quot;Error: type expected&quot;
    style=&quot;width:100%;max-width:600px&quot;
    hspace=&quot;8pt&quot; vspace=&quot;8pt&quot;&gt;&lt;/a&gt;&lt;/center&gt;&lt;br&gt;&lt;p&gt;That's it. Nothing more. It's actually pretty awesome, can't do better short of pulling out a gun and shooting you right in the face. Let me tell you how to reproduce this, just comment the &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L88&quot;&gt;objType assignment&lt;/a&gt; in the &lt;a href=&quot;https://github.com/gradha/gradha.github.io/blob/master/code/18/utils.nim#L84&quot;&gt;generateProperties()&lt;/a&gt; static proc, like this:&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Keyword&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;generateProperties&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirrty&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;objType&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;varName&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;varType&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;PNimrodNode&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;Comment&quot;&gt;# Create identifiers from the parameters.&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;let&lt;/span&gt;
      &lt;span class=&quot;Comment&quot;&gt;#objType = !(objType)&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;varType&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;varType&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;setter&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;varName&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;=&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt; This error happens because the &lt;code&gt;objType&lt;/code&gt; is a string literal, but instead of a string literal the &lt;code&gt;quasi-quoting&lt;/code&gt; macro needs a &lt;code&gt;TNimrodIdent&lt;/code&gt;, which is obtained through the &lt;a href=&quot;http://nimrod-lang.org/macros.html#!,string&quot;&gt;!() operator&lt;/a&gt;. That's why removing this re-assignment breaks everything and you are left wondering &lt;span style=&quot;font-weight: bold;&quot;&gt;where to start looking for problems because there is no starting point at all&lt;/span&gt;. And unfortunately it can't be fixed easily. By the time the compiler goes through the quasi-quoting it doesn't know better if what it is generating is right or wrong, and by the time it reaches a further phase of the compiler, since it was all generated code, there are no actual line numbers to keep track of what was generated where.&lt;/p&gt;
&lt;p&gt;How could this be improved? Maybe the &lt;a href=&quot;http://nimrod-lang.org/macros.html&quot;&gt;macros&lt;/a&gt; module could grow an &lt;code&gt;annotateNode&lt;/code&gt; helper which when used would annotate the specified node with the current line/column where the &lt;code&gt;annotateNode&lt;/code&gt; helper actually is in the source file. Kind of like &lt;code&gt;printf&lt;/code&gt; cavemen debugging. Or maybe instead of trying to preserve stack traces which are typical of runtime environments the compiler could actually dump the AST it is processing with a little arrow pointing at the node that is giving problems? Honestly, if instead of this error I had gotten the AST with an arrow pointing at the string literal I would at least know where to start looking at, even if by the mere AST I still might have trouble finding out why a string literal is not expected. But you would at least have a starting point. The ASTs can get quite big, so it would help if the compiler could dump the problematic AST to a temporary file for inspection with an editor rather than scrolling through pages of terminal output.&lt;/p&gt;
&lt;p&gt;Talking about cavemen debugging, the only sources of information you have now for development of macros are the &lt;a href=&quot;http://nimrod-lang.org/macros.html#dumpTree&quot;&gt;dumpTree()&lt;/a&gt; and &lt;a href=&quot;http://nimrod-lang.org/macros.html#treeRepr&quot;&gt;treeRepr()&lt;/a&gt; helpers and repeated trips to the command line to compile stuff. It would be really nice if the &lt;a href=&quot;https://github.com/nimrod-code/Aporia&quot;&gt;official Nimrod IDE Aporia&lt;/a&gt; had a mode where you could open a bit of code in a separate window and it would refresh the AST as you write, pointing at problematic places, or maybe offering links to the documentation as you write code. Or maybe a mode where you directly write the AST, and the IDE generates the source code for you? Maybe this could work off with proper auto completion. Right now the amount of different AST nodes is quite scary but many of them don't interact with each other unless specific conditions are met.  Who knows, it could be easier to follow than looking through the documentation. Or maybe it would be useless anyway because programming in Java is all the rage.&lt;/p&gt;
&lt;h1&gt;Conclusion&lt;/h1&gt;&lt;p&gt;Even with the rough edges, expected in a programming language which hasn't yet reached version 1.0 and is already running circles around established programming languages, macros are a complete win for programming. They allow you to become a compiler developer and extend the language just that little bit in the direction you need to make your life easier. Only without the pain and embarrassment of pull requests being reviewed and rejected. And let's face it, figuring out how macros work and how to write them is in itself a fun exercise.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.youtube.com/watch?v=thabOb8WX34&quot;&gt;I'd&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=6KRb4buwa3A&quot;&gt;also&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=85kgIuq3HY4&quot;&gt;like&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=8NFXElCZY4I&quot;&gt;to&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=8NFXElCZY4I&quot;&gt;thank&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=Dgwth72XZCQ&quot;&gt;the&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=Hpp4mXPihZg&quot;&gt;wonderful&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=Htjh6Vyxkws&quot;&gt;Ace&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=Hxxoyc05hWQ&quot;&gt;of&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=IJDckhfF0Z4&quot;&gt;Angels&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=Qwr_aRE-PRw&quot;&gt;for&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=RCybFtD9ROg&quot;&gt;their&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=Rie4knPIKPw&quot;&gt;performances&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=Vdd-z87h0Ek&quot;&gt;and&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=XSxbmpBMz0E&quot;&gt;the&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=YvnlMaYUe24&quot;&gt;dozens&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=ZpgTevBUStE&quot;&gt;of&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=_2oVTghzm5I&quot;&gt;Korean&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=_39a5TJC47E&quot;&gt;camera&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=bQ3XlIQyPEI&quot;&gt;men&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=chkdylyKgJE&quot;&gt;offering&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=f0uY0zFG0y8&quot;&gt;high&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=fLZG31_AKsQ&quot;&gt;quality&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=ljwkRDdhjVM&quot;&gt;captures&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=mG_UY_SCKqg&quot;&gt;of&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=n3cZIdMd5QM&quot;&gt;them&lt;/a&gt;. &lt;a href=&quot;http://www.youtube.com/watch?v=nflUbvqSgMU&quot;&gt;They&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=ooJiMFG-Uuo&quot;&gt;were&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=ozDnGDxh7ZA&quot;&gt;crucial&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=r-4_j1V6frE&quot;&gt;to&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=x9O26UkN9AA&quot;&gt;overcome&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=yku6QKz6Drc&quot;&gt;the&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=6Zl5M-7tORI&quot;&gt;hurdles&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=xryLWlBfXa0&quot;&gt;mentioned&lt;/a&gt; &lt;a href=&quot;http://www.youtube.com/watch?v=39B3AeTD0lY&quot;&gt;above&lt;/a&gt;.&lt;/p&gt;
&lt;pre class='literal'&gt;$ nimrod c -r miniskirt
miniskirt.nim(3, 0) Info: instantiation from here
???(???, ???) Error: 4k youtube video expected&lt;/pre&gt;
      </content>
    </entry>
    <entry>
      <title>Will iCloud deliver this time?</title>
      <link rel="alternate" type="text/html" href="http://gradha.github.io/articles/2014/07/will-icloud-deliver-this-time.html"/>
      <id>http://gradha.github.io/articles/2014/07/will-icloud-deliver-this-time.html</id>
      <published>2014-07-29T00:19:00Z</published>
      <updated>2014-07-29T00:19:00Z</updated>
      <author><name>Grzegorz Adam Hankiewicz</name></author>
      <content type="html">
        &lt;h1&gt;Will iCloud deliver this time?&lt;/h1&gt;&lt;p&gt;Somewhere around September, or maybe October, Apple will release &lt;a href=&quot;https://en.wikipedia.org/wiki/IOS_8&quot;&gt;iOS 8&lt;/a&gt; and &lt;a href=&quot;https://en.wikipedia.org/wiki/OS_X_Yosemite&quot;&gt;OS X 10.10 Yosemite&lt;/a&gt;. One of the highlights of this release will be &lt;a href=&quot;http://arstechnica.com/apple/2014/06/apple-announces-ios-8-at-wwdc/&quot;&gt;CloudKit&lt;/a&gt;, which will be sort of like... Dropbox. Or maybe Google Drive/Google App Engine. In fact, the newer OS versions will finally show &lt;span style=&quot;font-style: italic;&quot;&gt;files&lt;/span&gt; on your device. You know, that ugly thing Apple has been trying to force you forget about and nobody wants to touch.&lt;/p&gt;
&lt;p&gt;The sad thing is that CloudKit seems like it will be their current iCloud with a slightly more open and feature full API. Why sad? Well, &lt;a href=&quot;http://blackpixel.com/blog/2013/03/the-return-of-netnewswire.html&quot;&gt;there has been&lt;/a&gt; &lt;a href=&quot;http://createlivelove.com/246&quot;&gt;plenty said about&lt;/a&gt; &lt;a href=&quot;http://www.theverge.com/2013/3/26/4148628/why-doesnt-icloud-just-work&quot;&gt;how much iCloud&lt;/a&gt; &lt;a href=&quot;http://inessential.com/2013/03/27/why_developers_shouldnt_use_icloud_sy&quot;&gt;actually sucks&lt;/a&gt; &lt;a href=&quot;http://informalprotocol.com/2012/11/your-app-needs-to-sync/&quot;&gt;from the developer point of view&lt;/a&gt;. In fact, I have tried to use iCloud and I can tell you that yes, except for really really tiny bits of data &lt;span style=&quot;font-style: italic;&quot;&gt;you don't care about&lt;/span&gt;, it sucks badly in terms of performance. For anything that you &lt;span style=&quot;font-style: italic;&quot;&gt;care about&lt;/span&gt; you should avoid iCloud (at least in its current version).&lt;/p&gt;
&lt;p&gt;During the past days of beta and candidate release polishing, Apple &lt;a href=&quot;http://www.macrumors.com/2014/07/04/apple-cloudkit-wipe-july-7/&quot;&gt;told developers at the beginning of July&lt;/a&gt; that they would be wiping data for certain types of applications using CloudKit. Huh, really? We aren't talking about a few noobs getting together and putting a website for the first time. Presumably we are talking about Apple, who started doing &lt;a href=&quot;http://www.youtube.com/watch?v=b2F-DItXtZs&quot;&gt;web scale&lt;/a&gt; stuff in iOS 5 (more than two years ago now!). Oh well. Wouldn't be that scary unless… wait, now I got another mail, they are wiping all CloudKit public databases on July 22 too. Which begs the question: are they actually building on their old shit or are they inventing new shit which will have its own set of new bugs (ahem, features)?&lt;/p&gt;
&lt;p&gt;This sad history of previous facts doesn't reassure me things will be happy in the future. In fact, that's all from the developer's point of view. But let me tell you about the user point of view for what iCloud has been up till today.&lt;/p&gt;
&lt;h1&gt;Reminders&lt;/h1&gt;&lt;p&gt;The reminders app is like your Hello World for network programmers. Only programmers typically call it &lt;span style=&quot;font-weight: bold;&quot;&gt;TODO&lt;/span&gt;. You have a bunch of tasks, you set a date (or not) and you go checking them when you finish. Pretty simple, how could you not make this work? Bad news, reminders still works incorrectly sometimes.  One of the typical problems I have with it are periodical reminders. These are todo tasks which at a certain date they give you an alarm, and badge the application icon to remind you you have &lt;span style=&quot;font-style: italic;&quot;&gt;N&lt;/span&gt; tasks pending to check. So you check them, exit… and the badge doesn't change. So you go again in, the task is deleted, go out, nope, the badge still has a number. Go in… wait, the task reappeared again? You check it, go out, oh finally, now it's checked and there is no badge.&lt;/p&gt;
&lt;p&gt;Another problem happens when you have multiple devices. For instance, let's say you have a task with a date, and you have a laptop and an iPhone. You add the reminder and off you go. Then, at some point you get an alert both on the iPhone and the computer, just slightly off because their clocks are not exactly the same. Say, you open the iPhone app and check it. Also on the laptop you click the notification away. Only problem is for some reason if you click off the notification, the iPhone task appears as non checked the next time you open the app. And with a badge too!&lt;/p&gt;
&lt;p&gt;It's as if the iphone is sending the check, then the mac is sending the check, something goes terribly wrong and one things it has not been done. Sometimes this happens to me with dates. I change the date of a reminder and other devices don't have it updated, but I check them anyway. Only later the reminders reappear with the modified date. As if the &lt;span style=&quot;font-style: italic;&quot;&gt;I-modified-the-date&lt;/span&gt; reaches after the &lt;span style=&quot;font-style: italic;&quot;&gt;I-deleted-the-task&lt;/span&gt; and this revives the deleted reminder.&lt;/p&gt;
&lt;h1&gt;iMessages&lt;/h1&gt;&lt;p&gt;It was really cool to be able to send SMS like messages for free and from the laptop to other iPhone users. Only until you realise it sucks so much and stop using this. The most annoying thing is that delivery is random. I've received messages up to two days after they were sent. But that's when you get lucky. The bad is when messages &lt;span style=&quot;font-weight: bold;&quot;&gt;never&lt;/span&gt; reach. And this is actually fun to see when you have multiple devices connected to the same iCloud account.&lt;/p&gt;
&lt;p&gt;The other day I started a talk with my sister. Wrote a message from the laptop. After some time the iPhone revives with an answer. I wait a few minutes… but nothing, the laptop doesn't receive the answer. Anyway, I type the answer on the laptop and again, after some minutes, I get a notification, this time on the iPhone, and 30 seconds later on the iPad (which didn't get the first answer), and… not on the laptop. Huh. Rinse and repeat. Now I get both device notifications, and yes, finally! The laptop iMessages app shows the &lt;span style=&quot;font-style: italic;&quot;&gt;user-is-typing-a-reply&lt;/span&gt; icon. I get the answer on the iPhone, then the iPad… and after three minutes the &lt;span style=&quot;font-style: italic;&quot;&gt;typing&lt;/span&gt; icon disappears, and get a blank screen, no reply.&lt;/p&gt;
&lt;h1&gt;Calendar&lt;/h1&gt;&lt;p&gt;Up until Mavericks, my laptop would show &lt;span style=&quot;font-style: italic;&quot;&gt;&amp;quot;syncing calendars&amp;quot;&lt;/span&gt; or something like that, only it would never stop. I would have to kill the calendar app and open it again. For some reason then it would &lt;span style=&quot;font-style: italic;&quot;&gt;usually&lt;/span&gt; work. What was the calendar syncing? Why did it use a blocking alert dialog anyway preventing me from using the rest of the app locally? And is it actually gone in Mavericks? Haven't seen that odd alert, but I've seen my calendar not having certain events I added on my iPhone.&lt;/p&gt;
&lt;h1&gt;Mail&lt;/h1&gt;&lt;p&gt;A hahahahaha. &lt;span style=&quot;font-weight: bold;&quot;&gt;Just no&lt;/span&gt;. I'm not letting them mangle work email after seeing what they do with trivial data. Plus I've found out that sometimes the Mavericks mail app doesn't work very well with IMAP drafts. You delete the draft and after some time it appears again (usually after quitting and opening Mail again). The only way to get rid of such ghost drafts is to nuke them on the server with whatever web mail interface you have, or a saner IMAP client.&lt;/p&gt;
&lt;h1&gt;iPhoto&lt;/h1&gt;&lt;p&gt;Apple's picture managing software doesn't necessarily use iCloud, but you can enable the &lt;span style=&quot;font-weight: bold;&quot;&gt;photo stream&lt;/span&gt; or whatever is its official branding name, and presumably devices will upload photos to the iCloud. Then in iPhoto you enable the &amp;quot;download automatically from iCloud stuff&amp;quot; option. This is very nice, you don't have to connect the devices to the computer and pictures start to appear. Only like previously said, sometimes pictures never appeared.&lt;/p&gt;
&lt;p&gt;But more importantly, deleted pictures &lt;span style=&quot;font-style: italic;&quot;&gt;can't be killed&lt;/span&gt;! Let me explain. When I take pictures with the iPhone, since it's a mobile and they usually suck to take pictures, and the LCD doesn't show really anything, I always take several pictures of the same scene, then on the computer I look at them carefully and pick the best. The rest get deleted.&lt;/p&gt;
&lt;p&gt;Well, the photo stream stores up to 1000 pictures. What I noticed is that after several days passed since I deleted the imported photos in iPhoto… they would come back! I noticed this by chance, I started looking at previous picture rolls and I would have duplicated pictures. This is because I would have the original picture version from iCloud, and the one which I would edit, modify, then save and re compress outside of iPhoto to reimport again and save precious disk space (usually iDevices use lousy JPG compression to preserve shitty background noise from mobile pictures you don't want to keep anyway, so re compressing the pictures saves a lot of space without noticeable quality loss).&lt;/p&gt;
&lt;p&gt;So I disabled the iPhoto importation. Then I disabled iPhoto stream, because I realized I don't want it for anything else and could live better with Apple not sneakily looking at my personal pictures.&lt;/p&gt;
&lt;p&gt;Oh, and not related to iCloud, I had about 10,000 images tagged with faces but one day I went to the faces option in iPhoto and all had vanished. Well, let's look in Time Machine… nope, the oldest backup didn't have them. Way to go Apple, you lose user data and don't even bother to tell us.&lt;/p&gt;
&lt;h1&gt;iTunes&lt;/h1&gt;&lt;p&gt;Not totally related to iCloud, this shows how bad their network implementation tends to be. Previous to iCloud (I believe) iTunes started to have wifi sync. Wohoo! Never connect your iPhone again and be able to transfer data to it any time! Sounds really nice. Started to use it and… nope, from random syncs which would not finish but not give errors (which means stuff would not be copied and you are not notified) to the most dreaded iPhone is 5cm away from laptop but they don't see each other until you reboot both devices!&lt;/p&gt;
&lt;p&gt;Now I don't use wifi iTunes sync on any device, and to avoid &lt;span style=&quot;font-style: italic;&quot;&gt;support calls&lt;/span&gt; nobody in my family does either.&lt;/p&gt;
&lt;h1&gt;Podcasts&lt;/h1&gt;&lt;p&gt;The podcasts app has really troubles to keep in sync. So much that from time to time I open it and all my &lt;span style=&quot;font-style: italic;&quot;&gt;feeds&lt;/span&gt; are duplicated. Cool, now which one is the good one? They are identical. But I delete one and keep using whatever podcast I was listening too. Only later that deletion seems to make no more podcast update. So you have to go on the device and computer, purge all, then refresh and create new subscriptions. Amazing quality, have had it happened twice already, and now I &lt;span style=&quot;font-style: italic;&quot;&gt;see&lt;/span&gt; dupe feeds again, but I've learned to just look in another direction and not try to delete them.&lt;/p&gt;
&lt;p&gt;Two is better than one anyway.&lt;/p&gt;
&lt;h1&gt;Contacts&lt;/h1&gt;&lt;p&gt;I don't have anything bad to say about Contacts. Except that one time where I noticed nothing would sync. At some point, contacts would simply not &lt;span style=&quot;font-style: italic;&quot;&gt;cross over&lt;/span&gt; from the laptop to the iPhone or vice versa, neither changes to previous contacts neither new entries. What was wrong? I even made some tests, creating new items, forcing refresh however I could, but nothing.&lt;/p&gt;
&lt;p&gt;After travelling the deep Apple support forums I found that the laptop was at least logging some errors during sync. Then with some arcane command line commands I was able to convert strange looking universal identifier codes into address book contacts, purge them, and reimport them again. Then it started to work again.&lt;/p&gt;
&lt;p&gt;Oh, maybe not. It actually started to work again when I stopped syncing contacts through iTunes. You see, you can sync both through iCloud and through the physical connection. Not a good idea. Use one, but not both, otherwise you have weird problems too.&lt;/p&gt;
&lt;h1&gt;Conclusion&lt;/h1&gt;&lt;p&gt;I would love if this stuff worked. But right now as you can see I've disabled pretty much everything related to network sync because Apple can't make it work. And third party developers can't make it work either, I wonder why would that be… or why most solutions involve turning off Apple features/software. Whatever I choose in the future for web sync/development I will make sure it has no relationship to Apple.&lt;/p&gt;
&lt;p&gt;Still, good luck Apple! I hope you make the best software! No hard feelings on the years of pain you have provided me and my loved ones!&lt;/p&gt;
&lt;pre class='literal'&gt;$ wget http://apple.com/icloud-just-works
...
2014-07-29 01:19:38 ERROR 404: Not Found.&lt;/pre&gt;
      </content>
    </entry>
    <entry>
      <title>Why I will never use an iWatch</title>
      <link rel="alternate" type="text/html" href="http://gradha.github.io/articles/2014/07/why-i-will-never-use-an-iwatch.html"/>
      <id>http://gradha.github.io/articles/2014/07/why-i-will-never-use-an-iwatch.html</id>
      <published>2014-07-09T19:05:00Z</published>
      <updated>2014-07-12T13:19:00Z</updated>
      <author><name>Grzegorz Adam Hankiewicz</name></author>
      <content type="html">
        &lt;h1&gt;Why I will never use an iWatch&lt;/h1&gt;&lt;p&gt;Because I've always hated things on my arms. I don't wear any and don't plan to.&lt;/p&gt;

&lt;center&gt;&lt;a href=&quot;http://www.idol-grapher.com/1235&quot;&gt;&lt;img
    src=&quot;../../../i/do_not_want.jpg&quot;
    alt=&quot;AOA doesn't want either&quot;
    style=&quot;width:100%;max-width:600px&quot;
    hspace=&quot;8pt&quot; vspace=&quot;8pt&quot;&gt;&lt;/a&gt;&lt;/center&gt;&lt;p&gt;Wow, that was short and sweet for a change!&lt;/p&gt;
&lt;pre class='literal'&gt;$ date -u
miércoles,  9 de julio de 2014, 18:05:42 UTC&lt;/pre&gt;
      </content>
    </entry>
    <entry>
      <title>Dirrty objects, in dirrty Nimrod</title>
      <link rel="alternate" type="text/html" href="http://gradha.github.io/articles/2014/06/dirrty-objects-in-dirrty-nimrod.html"/>
      <id>http://gradha.github.io/articles/2014/06/dirrty-objects-in-dirrty-nimrod.html</id>
      <published>2014-06-07T19:23:00Z</published>
      <updated>2014-10-12T21:55:00Z</updated>
      <author><name>Grzegorz Adam Hankiewicz</name></author>
      <content type="html">
        &lt;h1&gt;Dirrty objects, in dirrty Nimrod&lt;/h1&gt;&lt;p&gt;This article has been optimized for search engines by using the misspelled word &lt;span style=&quot;font-weight: bold;&quot;&gt;dirrty&lt;/span&gt;. If you came here looking for some hot girls, please go instead to Youtube to watch &lt;a href=&quot;https://www.youtube.com/watch?v=4Rg3sAb8Id8&quot;&gt;Christina Aguilera's Dirrty video&lt;/a&gt; where she works it out. At the moment of writing this article the video records 7.226.476 views, some more won't hurt. For all the other boring people, welcome again to another technical article only worth reading while you wait for the compiler to do its job (or for your browser to render some JavaScript, if you are one of those hipster types).&lt;/p&gt;
&lt;p&gt;In what looks like a distant past, I used to write Objective-C code for the iPhone. In one of the projects, a little client consuming JSON would fetch news from a web server and cache them locally using SQLite. The code I initially wrote worked fine for about 50 to 100 items, which was the expected workload. Years later this code was moved to another project where the item requirement jumped to over 600+ items and suddenly the user interface was all jerky. As if you were using a cheap Android device instead of the silky smooth luxury car the iPhone feels like (platform fanboys will be glad to know I replicated the silky smooth experience on Android 2.1 devices with less computing power than a cereal box).&lt;/p&gt;
&lt;p&gt;Certainly 600 didn't seem an incredibly big number (though it was &lt;a href=&quot;https://en.wikipedia.org/wiki/300_(comics)&quot;&gt;twice as Sparta&lt;/a&gt;, respekt man), so why was it all slow suddenly?  Fortunately there were two things I could quickly do to alleviate the problem and not look back:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;SQL transactions.&lt;/li&gt;&lt;li&gt;Marking objects as &lt;a href=&quot;https://en.wikipedia.org/wiki/Dirrty&quot;&gt;dirrty&lt;/a&gt;.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;Experienced Objective-C programmers with knowledge of &lt;a href=&quot;https://en.wikipedia.org/wiki/Core_Data&quot;&gt;Core Data&lt;/a&gt; will surely roll their eyes at this point as both of these problems are handled automatically by the framework. The SQL transactions is the obvious facepalm: using a database without taking care of transactions is like pushing a bicycle instead of riding it. You have this shiny thingy beside you which helps you and you are ignoring it. But after placing a few BEGIN/COMMIT here and there the saving wasn't instant yet (remember, you have to aim for perfect, always).&lt;/p&gt;
&lt;p&gt;The 600+ item requirement didn't actually come from increased network traffic. The server would still serve data in chunks of about 50 items. However, the items would be cached locally until a certain expiration date and thus when new items arrived the older ones were still there. That was the problem: the code was blindly saving all the objects even when they had not changed at all. That's where the &lt;span style=&quot;font-weight: bold;&quot;&gt;dirrty&lt;/span&gt; flag comes, the code would mark any new or modified object as &lt;span style=&quot;font-weight: bold;&quot;&gt;dirrty&lt;/span&gt; and the SQLite saving code would skip the items without this flag.  With these two new measures in place the client performed again seemingly instantly and scrolling was fast again even on first generation devices.&lt;/p&gt;
&lt;h1&gt;The reference Objective-C implementation&lt;/h1&gt;
&lt;a href=&quot;https://en.wikipedia.org/wiki/File:Dirrty_Slutdrop.jpg&quot;&gt;&lt;img
    src=&quot;../../../i/wikipedia_slutdrop.jpg&quot;
    alt=&quot;Christina doing the slutdrop&quot;
    style=&quot;width:100%;max-width:750px&quot; align=&quot;right&quot;
    hspace=&quot;8pt&quot; vspace=&quot;8pt&quot;&gt;&lt;/a&gt;&lt;p&gt;The implementation of the &lt;span style=&quot;font-weight: bold;&quot;&gt;dirrty&lt;/span&gt; flag is not really hard at all, just tedious. In Objective-C you tend to build your serialized objects around an inheritance tree where the base class provides the basic serialization methods. Subclasses can then call &lt;code&gt;super&lt;/code&gt; and extend the serialization (in my case, JSON dictionaries) with whatever new properties the parent class was not aware of.&lt;/p&gt;
&lt;p&gt;The first step is to create a data model super class which already contains the &lt;span style=&quot;font-weight: bold;&quot;&gt;dirrty&lt;/span&gt; flag. Then you provide setter/getters for properties. In Objective-C setters/getters can be implemented by the compiler automatically through &lt;code&gt;@property&lt;/code&gt; and &lt;code&gt;@synthethize&lt;/code&gt;. But you can also implement them yourself. In my case I created the following C macros which would expand to setters marking the &lt;span style=&quot;font-weight: bold;&quot;&gt;dirrty&lt;/span&gt; flag:&lt;/p&gt;

&lt;br clear=&quot;right&quot;&gt;&lt;pre class='literal'&gt;
#define SS_DIRRTY_ASSIGN_SETTER(NAME,TYPE,VAR) \
    - (void)NAME:(TYPE)VAR { \
            VAR ## _ = VAR; \
            dirrty_ = YES; \
    }

#define SS_DIRRTY_RETAIN_SETTER(NAME,TYPE,VAR) \
    - (void)NAME:(TYPE)VAR { \
            [VAR retain]; \
            [VAR ## _ release]; \
            VAR ## _ = VAR; \
            dirrty_ = YES; \
    }

// Actual later usage:
SS_DIRRTY_RETAIN_SETTER(setBody, NSString*, body)
SS_DIRRTY_RETAIN_SETTER(setFooter, NSString*, footer)&lt;/pre&gt;&lt;p&gt;Not the prettiest code in the world, but works fine. There are two versions of the macro, one for scalar values and another for objects which requires the &lt;code&gt;retain/release&lt;/code&gt; dance. The last two lines would be seen in a subclass implementation file where they would expand to a setter updating the &lt;code&gt;dirrty_&lt;/code&gt; flag. In recent Objective-C versions the getter is generated by the compiler, but we could add the getter generation to these macros as well for ancient compiler compatibility.&lt;/p&gt;
&lt;h1&gt;Dirrtying Nimrod&lt;/h1&gt;&lt;p&gt;In the &lt;a href=&quot;http://nimrod-lang.org&quot;&gt;Nimrod programming language&lt;/a&gt; we can replicate the C macros with some improvements. Here is the code of a &lt;code&gt;utils.nim&lt;/code&gt; file:&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;macros&lt;/span&gt;

&lt;span class=&quot;Comment&quot;&gt;# Create a superclass with the dirrty flag.&lt;/span&gt;
&lt;span class=&quot;Keyword&quot;&gt;type&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;Dirrty&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;object&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;TObject&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;dirrty&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;bool&lt;/span&gt;

&lt;span class=&quot;Keyword&quot;&gt;macro&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;generateProperties&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;objType&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;varName&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;varType&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;expr&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;stmt&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;# Create identifiers from the parameters.&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;let&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;setter&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;varName&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;=&amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;iVar&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;StringLit&quot;&gt;&amp;quot;F&amp;quot;&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;varName&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;getter&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;varName&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
  
  &lt;span class=&quot;Comment&quot;&gt;# Generate the code using quasiquoting.&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;quote&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;Keyword&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;setter&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;objType&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;Identifier&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;varType&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;inline&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;iVar&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;value&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirrty&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;true&lt;/span&gt;
    
    &lt;span class=&quot;Keyword&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;getter&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;objType&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;varType&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;Punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;inline&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
      &lt;span class=&quot;Identifier&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;iVar&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;`&lt;/span&gt;
&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;As scary as this code may look to any beginner in the language, the nice thing is that you can put it aside in a separate file and not look at it ever again. It is not very difficult to understand either. The first thing it does is import the &lt;a href=&quot;http://nimrod-lang.org/macros.html&quot;&gt;macros module&lt;/a&gt; which contains many meta programming helpers. Then it defines a &lt;code&gt;Dirrty&lt;/code&gt; base class which includes the &lt;code&gt;dirrty: bool&lt;/code&gt; field. User defined objects will inherit from the class.&lt;/p&gt;
&lt;p&gt;The second (scary) thing this code does is define the &lt;code&gt;generateProperties&lt;/code&gt; macro. This macro accepts a user defined type, a variable name, and the type of this variable. Then proceeds to create in the &lt;code&gt;let&lt;/code&gt; block the names of the setter, getter and instance variable that will be used to access the object. This is done &lt;a href=&quot;http://nimrod-lang.org/macros.html#$,PNimrodSymbol&quot;&gt;converting the parameter Nimrod symbol to a string&lt;/a&gt;, mangling the string, then &lt;a href=&quot;http://nimrod-lang.org/macros.html#!,string&quot;&gt;constructing again an identifier from this new string&lt;/a&gt;. Note how you can apply crazy logic here depending on names of the variables, something which is hard or impossible to do in C macros.&lt;/p&gt;
&lt;p&gt;Once the identifiers are generated, using &lt;a href=&quot;http://nimrod-lang.org/macros.html#quote&quot;&gt;quasi-quoting&lt;/a&gt; we define a setter and getter proc with the generated identifiers. The backticks are what will be replaced in the final code, and all of this is assigned to the result of the macro, thus generating the wanted code. Whenever this call is found, the Nimrod compiler will generate the setter and getter for us. Now let's see a typical usage of this macro:&lt;/p&gt;
&lt;p&gt;&lt;pre class='code'&gt;&lt;span class=&quot;Keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;utils&lt;/span&gt;

&lt;span class=&quot;Keyword&quot;&gt;type&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;object&lt;/span&gt; &lt;span class=&quot;Keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;Dirrty&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;Fname&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;Fsurname&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;
    &lt;span class=&quot;Identifier&quot;&gt;Fage&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;int&lt;/span&gt;

&lt;span class=&quot;Identifier&quot;&gt;generateProperties&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;Identifier&quot;&gt;generateProperties&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;surname&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;Identifier&quot;&gt;generateProperties&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;age&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;Keyword&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;Comment&quot;&gt;## Exercise the setters and getters.&lt;/span&gt;
  &lt;span class=&quot;Keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;Person&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;Operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Christina&amp;quot;&lt;/span&gt;
  &lt;span class=&quot;Identifier&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot;Is &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;StringLit&quot;&gt;&amp;quot; dirrty? &amp;quot;&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;Operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;Identifier&quot;&gt;dirrty&lt;/span&gt;

&lt;span class=&quot;Keyword&quot;&gt;when&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;isMainModule&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;Identifier&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;Punctuation&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt; The &lt;code&gt;Person&lt;/code&gt; object defined here inherits from our &lt;code&gt;Dirrty&lt;/code&gt; base class and uses the &lt;a href=&quot;http://nimrod-lang.org/tut2.html#properties&quot;&gt;getter and setter convention&lt;/a&gt; of creating a &lt;span style=&quot;font-style: italic;&quot;&gt;private&lt;/span&gt; variable with the &lt;span style=&quot;font-weight: bold;&quot;&gt;F&lt;/span&gt; prefix. This variable can be accessed only from the current unit. After the type declaration we invoke the &lt;code&gt;generateProperties&lt;/code&gt; macro to &lt;span style=&quot;font-style: italic;&quot;&gt;produce&lt;/span&gt; at compilation time the setter and getter for each of the fields.&lt;/p&gt;
&lt;p&gt;What follows is a basic &lt;code&gt;test&lt;/code&gt; proc which verifies our assumptions by creating a &lt;code&gt;Person&lt;/code&gt; object, then echoing to screen the state of the &lt;span style=&quot;font-weight: bold;&quot;&gt;dirrty&lt;/span&gt; flag after using the generated setter to name it &lt;span style=&quot;font-weight: bold;&quot;&gt;Christina&lt;/span&gt;. You can surely expect the result by now:&lt;pre class='literal'&gt;
Is Christina dirrty? true&lt;/pre&gt;&lt;/p&gt;

&lt;center&gt;&lt;img
    src=&quot;../../../i/christina_punch.jpg&quot;
    alt=&quot;Hitting adversaries one macro at a time&quot;
    style=&quot;width:100%;max-width:750px&quot;
    hspace=&quot;8pt&quot; vspace=&quot;8pt&quot;&gt;&lt;/center&gt;&lt;br&gt;&lt;h1&gt;Conclusion&lt;/h1&gt;&lt;p&gt;In these few lines of code we have not just solved the hypothetical problem of marking automatically a flag in setter procs: we have actually implemented Objective-C style properties. Let that sink in. Nimrod doesn't provide properties, but instead it is flexible enough that it allows you, the end user programmer, to define your own language constructs. And you know what happens if you program in a language not flexible enough to stand the test of time? Yes, you are &lt;a href=&quot;https://developer.apple.com/swift/&quot;&gt;forced to switch to new incompatible languages&lt;/a&gt;. Otherwise you are stuck in the past.&lt;/p&gt;
&lt;p&gt;Could advanced Nimrod meta programming improve this example further?  Could we get rid of having to repeat the type of the field when creating the setters and getters and let the compiler figure it out? Could we avoid having to separate the definition of the object from the definition of the procs?&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://gradha.github.io/articles/2014/06/../10/adding-objectivec-properties-to-nimrod-objects-with-macros.html&quot;&gt;Who knows…&lt;/a&gt;&lt;/p&gt;
&lt;pre class='literal'&gt;$ playback slutdrop.m4a
Permission denied
Kernel DRM module not found&lt;/pre&gt;
      </content>
    </entry>
    <entry>
      <title>Songs for the NSA</title>
      <link rel="alternate" type="text/html" href="http://gradha.github.io/articles/2014/05/songs-for-the-nsa.html"/>
      <id>http://gradha.github.io/articles/2014/05/songs-for-the-nsa.html</id>
      <published>2014-05-15T21:45:00Z</published>
      <updated>2014-05-15T21:45:00Z</updated>
      <author><name>Grzegorz Adam Hankiewicz</name></author>
      <content type="html">
        &lt;h1&gt;Songs for the NSA&lt;/h1&gt;&lt;p&gt;In some firms there is silence at work. In others the firm pays to have music played globally, maybe because the decision people who want this are incapable of thoughts and the silence of their head scares them. At one of such firms I was lobotomized to love musical hits like &lt;a href=&quot;http://www.youtube.com/watch?v=WsYg48vuOTo&quot;&gt;Christina Aguilera's (aka P2P girl) Genio Atrapado (yes, in Spanish)&lt;/a&gt;, or &lt;a href=&quot;http://www.youtube.com/watch?v=ujuyt65WY0M&quot;&gt;Dame dame sung by Chayanne and Jennifer López&lt;/a&gt;.  It's a shame those two didn't release a promotional video. Or is it just I can't find it? Otherwise it would have looked really hot.&lt;/p&gt;
&lt;p&gt;Anyway, thanks to the revelations made by &lt;a href=&quot;https://en.wikipedia.org/wiki/Edward_Snowden&quot;&gt;Edward Snowden&lt;/a&gt; everybody knows about the &lt;a href=&quot;https://en.wikipedia.org/wiki/Nsa&quot;&gt;Not Such Agency&lt;/a&gt; and their orwellian acts. If they have music played at work, I'm sure their playlist will have hits like &lt;a href=&quot;https://www.youtube.com/watch?v=OMOGaugKpzs&quot;&gt;Every breath you take, by The police&lt;/a&gt;. Let's see some of the lyrics:&lt;/p&gt;

&lt;center&gt;&lt;em&gt;
Every breath you take&lt;br&gt;
And every move you make&lt;br&gt;
Every bond you break, every step you take&lt;br&gt;
I'll be watching you&lt;p&gt;

Every single day&lt;br&gt;
And every word you say&lt;br&gt;
Every game you play, every night you stay&lt;br&gt;
I'll be watching you&lt;p&gt;

Oh can't you see&lt;br&gt;
You belong to me&lt;br&gt;
How my poor heart aches&lt;br&gt;
With every step you take&lt;p&gt;

Every move you make&lt;br&gt;
And every vow you break&lt;br&gt;
Every smile you fake, every claim you stake&lt;br&gt;
I'll be watching you
&lt;/em&gt;&lt;/center&gt;&lt;p&gt;Don't you &lt;span style=&quot;font-weight: bold;&quot;&gt;love&lt;/span&gt; such classics?&lt;/p&gt;
&lt;pre class='literal'&gt;[~]$ cd work
[~/work]$ cd ethics
-bash: cd: ethics: No such file or directory
&lt;/pre&gt;
      </content>
    </entry>
    <entry>
      <title>Testing installation instructions</title>
      <link rel="alternate" type="text/html" href="http://gradha.github.io/articles/2014/05/testing-installation-instructions.html"/>
      <id>http://gradha.github.io/articles/2014/05/testing-installation-instructions.html</id>
      <published>2014-05-01T17:00:00Z</published>
      <updated>2014-05-01T17:34:00Z</updated>
      <author><name>Grzegorz Adam Hankiewicz</name></author>
      <content type="html">
        &lt;h1&gt;Testing installation instructions&lt;/h1&gt;&lt;p&gt;Unit testing seems like the most recent and popular &lt;a href=&quot;http://www.urbandictionary.com/define.php?term=e-penis&quot;&gt;e-penis&lt;/a&gt; game in the industry: not only can you brag about useless stuff in big numbers (&lt;span style=&quot;font-style: italic;&quot;&gt;look, we have more than thousand unit tests for stuff nobody uses!&lt;/span&gt;), but you can push this data to upper management and they will pat you on your back for it. Not because they find that unit testing is useful for software, promotes sane development approaches, documents working code and corner cases/bugs, or in general requires some interest in output from code monkeys.  No, they like unit testing because it can be represented as a number associated with specific developers, and the human resources department can compare these numbers over time to increase salaries. &lt;a href=&quot;http://stackoverflow.com/questions/3769716/how-bad-is-sloc-source-lines-of-code-as-a-metric&quot;&gt;It's lines of code all over again, and everybody loves it&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Except for very specific kinds of software, unit testing is likely not very useful to end users. In fact, when you test something &lt;span style=&quot;font-weight: bold;&quot;&gt;which matters&lt;/span&gt; to end users, it stops being called unit testing, and it is called &lt;a href=&quot;https://en.wikipedia.org/wiki/Integration_testing&quot;&gt;integration testing&lt;/a&gt; or &lt;a href=&quot;https://en.wikipedia.org/wiki/Verification_and_validation_(software)&quot;&gt;validation testing&lt;/a&gt;. This is serious crap. Like keeping virtual machines which simulate the &lt;span style=&quot;font-weight: bold;&quot;&gt;first installation&lt;/span&gt; by the user on an otherwise clean state OS (so you know if that 3rd party library you recently added requires an additional DLL install). Or if your software doesn't run in a virtual machine, keeping the hardware machines (with spares) to keep testing newer versions. These kinds of testing tend to take days compared to minutes in the software development.&lt;/p&gt;
&lt;p&gt;Unfortunately they are a pain in the ass to set up, so even important projects don't care about them and depend on beta test… er, users, to tell them something has gone wrong. One critical point of many open source projects which goes untested is: installation instructions. You know, the little sequence of commands which tells you what to do to actually get the source code, build it, and maybe install it. Either in binary or source form, installation instructions are the first step for your users and other potential developers to know about you. Bad installation instructions are the equivalent of a web page which never loads: users will look elsewhere. Yet they are not that difficult to test. In fact, everybody should be testing them.&lt;/p&gt;
&lt;h2&gt;Testing dropbox_filename_sanitizer&lt;/h2&gt;&lt;p&gt;For this article I'll be using my own &lt;a href=&quot;https://github.com/gradha/dropbox_filename_sanitizer&quot;&gt;dropbox_filename_sanitizer project&lt;/a&gt; because pointing errors in other people's software is too easy and doesn't enrich me. This project also offers a nice range of things to test: there is a stable source code installation, a development source code installation, and a pre built binary installation. In addition the program is implemented with the &lt;a href=&quot;http://nimrod-lang.org&quot;&gt;Nimrod programming language&lt;/a&gt; which &lt;a href=&quot;http://nimrod-lang.org/news.html#Z2014-04-21-version-0-9-4-released&quot;&gt;recently released version 0.9.4&lt;/a&gt;. A programming language in development may well render the source code useless between versions, so we will have to expand the source code tests to cover one using the stable compiler release and another using the unstable one. If my math is not wrong, that's more than a single test, enough to impress your mom.&lt;/p&gt;
&lt;p&gt;The platforms to test are MacOSX and Linux. You can test Windows too, you can do nice things with &lt;a href=&quot;https://oracleexamples.wordpress.com/2011/08/12/virtualbox-script-to-control-virtual-machines/&quot;&gt;VirtualBox alone&lt;/a&gt; or &lt;a href=&quot;http://www.vagrantup.com/blog/feature-preview-vagrant-1-6-windows.html&quot;&gt;with additional tools like Vagrant&lt;/a&gt;, but I don't own any Windows licenses and have little interest in getting one. Since both target platforms are Unix-like, we will be able to reuse the scripting for both using &lt;a href=&quot;https://www.gnu.org/software/bash/&quot;&gt;bash&lt;/a&gt; or whatever shell used by the systems used to run the test cases (if you don't control the environment, like on virtual host). We won't go the full virtual machine route because it is time expensive, and also because we can easily emulate nearly clean state environments through additional users.&lt;/p&gt;

&lt;img
    src=&quot;../../../i/nuke_orbit.jpg&quot;
    alt=&quot;The only sane approach to software testing&quot;
    style=&quot;width:100%;max-width:600px&quot; align=&quot;right&quot;
    hspace=&quot;8pt&quot; vspace=&quot;8pt&quot;&gt;&lt;p&gt;The strategy then is to create a separate user for testing in your own machine. This user won't have any of the installed dependencies required for installation, and we will install everything in specific directories which can later be erased to prevent them from polluting future tests. If the software you are using requires installation in global paths, you need a virtual machine then anyway. Certainly you don't &lt;span style=&quot;font-style: italic;&quot;&gt;trust&lt;/span&gt; software to have a good uninstallation mechanism, do you?&lt;/p&gt;
&lt;p&gt;A separate user account on the machine is easier to nuke from orbit should anything go wrong, but it also helps to keep yourself honest about the testing environment. If you run the tests as your development user many little environment changes can creep in and alter the tests. First we will write some code which will gather necessary runtime variables from the development environment or from json files producing a bash script. Then we copy the bash script to the user through a &lt;a href=&quot;https://en.wikipedia.org/wiki/Secure_Shell&quot;&gt;secure shell&lt;/a&gt; and run it remotely.&lt;/p&gt;
&lt;p&gt;The secure shell abstraction forces us to make a script which works remotely, can be run at any time, and we can run one instance in our development machine (MacOSX) and another one on a virtual box or hosted server (Linux). Secure shells are also easier to set up with public/private keys to avoid interactive prompts during testing. Of course you can set up passwords into the test scripts, but you have to be careful about &lt;a href=&quot;https://stewilliams.com/silly-gits-upload-private-crypto-keys-to-public-github-projects/&quot;&gt;private secrets not leaking to public repositories&lt;/a&gt;. Making sure the user ssh setup is &lt;span style=&quot;font-weight: bold;&quot;&gt;not&lt;/span&gt; part of your software repository can sometimes be a good thing.&lt;/p&gt;
&lt;h2&gt;Testing the stable babel installation&lt;/h2&gt;&lt;p&gt;To install the stable version of dropbox_filename_sanitizer the user only has to type the following commands:&lt;pre class='literal'&gt;
$ babel update
$ babel install argument_parser
$ babel install dropbox_filename_sanitizer&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;Fun fact: presumably you don't have to install &lt;a href=&quot;https://github.com/gradha/argument_parser&quot;&gt;argument_parser&lt;/a&gt; manually since &lt;a href=&quot;https://github.com/nimrod-code/babel&quot;&gt;babel&lt;/a&gt; will take care of dependencies. Unfortunately &lt;a href=&quot;https://github.com/nimrod-code/babel/issues/37&quot;&gt;a bug prevents correct installation&lt;/a&gt; due to a mistake in handling version numbers. Yes, the problem was found while &lt;a href=&quot;https://github.com/gradha/dropbox_filename_sanitizer/issues/12&quot;&gt;setting up the project for testing&lt;/a&gt; in advance for this blog post. Bug inception!&lt;/p&gt;
&lt;p&gt;Since the project already features a &lt;a href=&quot;https://github.com/gradha/dropbox_filename_sanitizer/blob/master/nakefile.nim&quot;&gt;nakefile&lt;/a&gt; which drives other tasks (see the &lt;a href=&quot;https://github.com/fowlmouth/nake&quot;&gt;nake project&lt;/a&gt;) I decided to add a &lt;a href=&quot;https://github.com/gradha/dropbox_filename_sanitizer/blob/329d5e7a52e5b4a705f89a68a751ce698e941501/nakefile.nim#L372&quot;&gt;shell_test&lt;/a&gt; command. This command accepts &lt;a href=&quot;https://github.com/gradha/dropbox_filename_sanitizer/tree/329d5e7a52e5b4a705f89a68a751ce698e941501/shell_tests&quot;&gt;json files&lt;/a&gt; which contain some parameters of what is to be tested. Let's see &lt;a href=&quot;https://github.com/gradha/dropbox_filename_sanitizer/blob/329d5e7a52e5b4a705f89a68a751ce698e941501/shell_tests/macosx_igor_nimrod_devel_chunk1.json&quot;&gt;one of those json files first&lt;/a&gt;:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;code&gt;host&lt;/code&gt;, &lt;code&gt;user&lt;/code&gt;: These are the typical host and user parameters for the secure shell. Use &lt;code&gt;localhost&lt;/code&gt; and a different user on your own machine to simulate a clean install.&lt;/li&gt;&lt;li&gt;&lt;code&gt;nimrod_branch&lt;/code&gt;: Specifies which branch to check out for the Nimrod compiler. You can specify tags as well for previous releases. In this case, we use the development branch.&lt;/li&gt;&lt;li&gt;&lt;code&gt;nimrod_version_str&lt;/code&gt;: The string we will use with &lt;a href=&quot;https://www.gnu.org/software/grep/&quot;&gt;grep&lt;/a&gt; in the script to verify that the compiler we invoke is the proper one. Since this is the development version, we don't care about the version, but stable version checking will feature a specific number (like 0.9.4).&lt;/li&gt;&lt;li&gt;&lt;code&gt;nimrod_csources_branch&lt;/code&gt;: Similar to &lt;code&gt;nimrod_branch&lt;/code&gt;, this is the branch used by the sub repository csources required by the compiler.&lt;/li&gt;&lt;li&gt;&lt;code&gt;chunk_file&lt;/code&gt;: Name of the documentation file we will extract installation steps performed by the user.&lt;/li&gt;&lt;li&gt;&lt;code&gt;chunk_number&lt;/code&gt;: Index of the instructions &lt;span style=&quot;font-style: italic;&quot;&gt;block&lt;/span&gt; that we are testing. The readme features several possible instructions, having different json files for each block.&lt;/li&gt;&lt;li&gt;&lt;code&gt;bin_version&lt;/code&gt;: Similar to &lt;code&gt;nimrod_version_str&lt;/code&gt;, this parameter specifies if we are testing against the development version of dropbox_filename_sanitizer (which will get the number directly imported from the module) or the last stable version (which will be obtained from git tags).&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;The nakefile code for the task is a little bit split and tough to follow sequentially, so I've put at &lt;a href=&quot;https://gist.github.com/gradha/aff3c6d53657a27e4cae&quot;&gt;https://gist.github.com/gradha/aff3c6d53657a27e4cae&lt;/a&gt; an example of generated shell script. This is the shell script that is copied to the remote user and run as is. The only dependency required is a working compiler. The script first sets up some variables to reuse, removes previous temporary files which could have been left from failure runs, and starts to install both the Nimrod compiler and babel. Quite boring, but necessary.&lt;/p&gt;
&lt;p&gt;By the very end of the script, &lt;a href=&quot;https://gist.github.com/gradha/aff3c6d53657a27e4cae#file-shell_test_1398956253-sh-L58&quot;&gt;on line 58&lt;/a&gt; you will recognise the three commands mentioned above to update babel, install argument_parser, then install the program. &lt;a href=&quot;https://gist.github.com/gradha/aff3c6d53657a27e4cae#file-shell_test_1398956253-sh-L54&quot;&gt;Previously line 54&lt;/a&gt; did export the private babel binary directory (&lt;code&gt;.babel/bin&lt;/code&gt;) to test a normal user invoking the binary without typing the full path to it. This can be seen in the &lt;a href=&quot;https://gist.github.com/gradha/aff3c6d53657a27e4cae#file-shell_test_1398956253-sh-L62&quot;&gt;last test line 62&lt;/a&gt; which verifies the installed version of the command running the command's &lt;code&gt;--version&lt;/code&gt; switch piped to &lt;a href=&quot;https://www.gnu.org/software/grep/&quot;&gt;grep&lt;/a&gt;. If &lt;code&gt;grep&lt;/code&gt; doesn't find a match it will return an error, which will abort the whole script, courtesy of &lt;a href=&quot;https://gist.github.com/gradha/aff3c6d53657a27e4cae#file-shell_test_1398956253-sh-L4&quot;&gt;line 4 forcing immediate exit&lt;/a&gt; if any of the following commands returns a non zero error status.&lt;/p&gt;
&lt;h2&gt;Testing the development babel installation&lt;/h2&gt;&lt;p&gt;To install the development version of dropbox_filename_sanitizer the user has to type a little bit more:&lt;pre class='literal'&gt;
$ babel update
$ babel install argument_parser
$ git clone https://github.com/gradha/dropbox_filename_sanitizer.git
$ cd dropbox_filename_sanitizer
$ babel install&lt;/pre&gt;&lt;/p&gt;
&lt;p&gt;The only difference is that instead of asking babel to fetch the package we clone the git repository and install it manually by omitting the parameter (and having a &lt;a href=&quot;https://github.com/gradha/dropbox_filename_sanitizer/blob/master/dropbox_filename_sanitizer.babel&quot;&gt;babel spec file available&lt;/a&gt; in the working directory). The only difference between the stable and development versions of the test script will be the lines run to install the software. These lines are obtained through the previously mentioned &lt;code&gt;chunk_number&lt;/code&gt; parameter in the json file.  The crude &lt;a href=&quot;https://github.com/gradha/dropbox_filename_sanitizer/blob/329d5e7a52e5b4a705f89a68a751ce698e941501/nakefile.nim#L252&quot;&gt;gen_chunk_script&lt;/a&gt; proc in the nakefile will parse the readme and extract all the lines for whatever block was specified. One could go hi-tech and use the &lt;a href=&quot;http://nimrod-lang.org/rst_module.html&quot;&gt;rst nimrod module&lt;/a&gt; to parse the readme, but simple line stripping serves well.&lt;/p&gt;
&lt;h2&gt;Testing the pre built binaries&lt;/h2&gt;&lt;p&gt;I haven't bothered yet to do this for a very simple reason: you only need to test this once. The compiled binaries work without dependencies, so by the time you create them, you test them yourself once and… that's it! It's the source installation which depends on many more steps and packages which can go wrong. Certainly there is room to test for &lt;a href=&quot;https://github.com/gradha/dropbox_filename_sanitizer/issues/11&quot;&gt;failures in the packaging itself&lt;/a&gt;, but the packaging itself is automated. Maybe if I get very bored I'll do it.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;img
    src=&quot;../../../i/so_metal.jpg&quot;
    alt=&quot;Tiffany approves&quot;
    style=&quot;width:100%;max-width:750px&quot; align=&quot;right&quot;
    hspace=&quot;8pt&quot; vspace=&quot;8pt&quot;&gt;&lt;p&gt;It takes some time to set these kind of tests, but they are critical: if potential users of your software find that they can't even install it, they won't bother to contact you to fix it, you require a lot of interest for that to happen. So you better know first that something is broken. The huge amount of github projects which don't even compile without tweaking is sad (or maybe I'm just unlucky?).&lt;/p&gt;
&lt;p&gt;As a bonus you know when things go wrong without others having to tell you. Since these integration tests also test external software, you are sort of contributing to the &lt;a href=&quot;http://forum.nimrod-lang.org&quot;&gt;Nimrod community&lt;/a&gt; by testing the compiler (both the last stable and last development versions) and the approved package manager used by many others.&lt;/p&gt;
&lt;p&gt;I've wondered if these tests should go the route of continuous integration. That seems to be a lot of work but possible through &lt;a href=&quot;https://developer.github.com/v3/repos/hooks/&quot;&gt;GitHub webhooks&lt;/a&gt;. On the other hand maybe webhooks don't work for watching external repositories you don't have control over. Since installation instructions are not going to change from day to day, it would be also possible to write a polling script which every night checks the current nimrod compiler version, and if changed, runs the tests.  Changing from continuous integration to nightly builds is not that bad either and still provides a reasonably fast response to external changes if something goes wrong.&lt;/p&gt;
&lt;p&gt;If you develop a Nimrod based pseudo continuous software tester, let me know!&lt;/p&gt;

&lt;br clear=&quot;right&quot;&gt;&lt;pre class='literal'&gt;$ unzip dropbox_filename_sanitizer-0.4.0-macosx.zip
Archive:  dropbox_filename_sanitizer-0.4.0-macosx.zip
  inflating: dropbox_filename_sanitizer
  inflating: readme.html
  …
$ ./dropbox_filename_sanitizer
-bash: ./dropbox_filename_sanitizer: Permission denied
&lt;/pre&gt;
      </content>
    </entry>
</feed>
